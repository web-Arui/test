ğŸ’– æœ€å¥½çš„webpackæ•™ç¨‹ï¼Œçœ‹å®˜æ–¹æ–‡æ¡£

webpackæ–‡æ¡£

æ–‡ä»¶å¯¹åº”çš„ç›®å½•

may-pack

>>å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡å­—å¤ªé•¿ç‚¹å‡»è¿›å…¥gitbook<<

- å®‰è£…å‰å…ˆnpmåˆå§‹åŒ–
- æœ¬åœ°æœåŠ¡
- å¤åˆ¶html
- å¤„ç†css
- å¤„ç†less
- æŠ½ç¦»cssæ–‡ä»¶ï¼Œé€šè¿‡linkå¼•å…¥
- å‹ç¼©csså’Œjs
- ç»™cssåŠ ä¸Šå…¼å®¹æµè§ˆå™¨çš„å‰ç¼€
- es6 è½¬ es5
- es 7çš„è¯­æ³•
- å…¨å±€å˜é‡å¼•å…¥
- webpackå›¾ç‰‡æ‰“åŒ…
- å½“å›¾ç‰‡å°äºå¤šå°‘ï¼Œç”¨base64
- æ‰“åŒ…æ–‡ä»¶åˆ†ç±»
- å¸Œæœ›è¾“å‡ºçš„æ—¶å€™ï¼Œç»™è¿™äº›css\imgåŠ ä¸Šå‰ç¼€ï¼Œä¼ åˆ°æœåŠ¡å™¨ä¹Ÿèƒ½è®¿é—®
- å¦‚æœåªå¸Œæœ›å¤„ç†å›¾ç‰‡
- æ‰“åŒ…å¤šé¡µåº”ç”¨
- é…ç½®source-map
- watch æ”¹å®Œä»£è¡¨é‡æ–°æ‰“åŒ…å®ä½“
- webpackçš„å…¶ä»–ä¸‰ä¸ªå°æ’ä»¶
- webpack è·¨åŸŸ
- å¦‚æœåç«¯ç»™çš„è¯·æ±‚æ²¡æœ‰API ã€Œè·¨åŸŸã€
- å‰ç«¯åªæƒ³å•çº¯mockæ•°æ® ã€Œè·¨åŸŸã€
- æœ‰æœåŠ¡ç«¯ï¼Œä¸ç”¨ä»£ç†, æœåŠ¡ç«¯å¯åŠ¨webpack ã€Œè·¨åŸŸã€
- webpackè§£æresolve
- ä½†æ˜¯æ¯æ¬¡å¼•å…¥éƒ½å¾ˆé•¿ï¼Œå¦‚ä½•ä¼˜é›…å¼•å…¥
- çœç•¥æ‰©å±•å
- å®šä¹‰ç¯å¢ƒå˜é‡
- åŒºåˆ†ä¸¤ä¸ªä¸åŒçš„ç¯å¢ƒ
- webpack ä¼˜åŒ–
- ä¼˜åŒ–ï¼šå½“æŸäº›åŒ…æ˜¯ç‹¬ç«‹çš„ä¸ªä½“æ²¡æœ‰ä¾èµ–
- ä¼˜åŒ–ï¼šè§„åˆ™åŒ¹é…è®¾ç½®èŒƒå›´
- ä¼˜åŒ–ï¼šå¿½ç•¥ä¾èµ–ä¸­ä¸å¿…è¦çš„è¯­è¨€åŒ…
- åŠ¨æ€é“¾æ¥åº“
- å¤šçº¿ç¨‹æ‰“åŒ…happypack
- webpack è‡ªå¸¦çš„ä¼˜åŒ–
- æŠ½å–å…¬å…±ä»£ç 
- æ‡’åŠ è½½(å»¶è¿ŸåŠ è½½)
- çƒ­æ›´æ–°(å½“é¡µé¢æ”¹å˜åªæ›´æ–°æ”¹å˜çš„éƒ¨åˆ†ï¼Œä¸é‡æ–°æ‰“åŒ…)
- tapableä»‹ç» - SyncHook
- tapableä»‹ç» - SyncBailHook
- tapableä»‹ç» - SyncWaterfallHook
- tapableä»‹ç» - SyncLoopHook
- AsyncParallelHook ä¸ AsyncParallelBailHook
  - AsyncParallelHook
  - AsyncParallelBailHook
- å¼‚æ­¥ä¸²è¡Œ â€”â€” AsyncSeriesHook
- å¼‚æ­¥ä¸²è¡Œ â€”â€” AsyncSeriesWaterfallHook
- æ‰‹å†™webpack
- webpackåˆ†æåŠå¤„ç†
- åˆ›å»ºä¾èµ–å…³ç³»
- asté€’å½’è§£æ
- ç”Ÿæˆæ‰“åŒ…å·¥å…·
- å¢åŠ loader
- å¢åŠ plugins
- loader
- é…ç½®å¤šä¸ªloader
- babel-loaderå®ç°
- banner-loaderå®ç°(è‡ªåˆ›)
- å®ç°file-loaderå’Œurl-loader
- less-loaderå’Œcss-loader
- css-loader
- webpack ä¸­çš„æ’ä»¶
- æ–‡ä»¶åˆ—è¡¨æ’ä»¶
- å†…è”çš„webpackæ’ä»¶
- æ‰“åŒ…åè‡ªåŠ¨å‘å¸ƒ

å®‰è£…å‰å…ˆnpmåˆå§‹åŒ–

    npm init -y
    npm i webpack webpack-cli -D

    let path = require('path')   // ç›¸å¯¹è·¯å¾„å˜ç»å¯¹è·¯å¾„
    
    module.exports = {
        mode: 'production', // æ¨¡å¼ é»˜è®¤ production development
        entry: './src/index',    // å…¥å£
        output: {
            filename: 'bundle.[hash:8].js',   // hash: 8åªæ˜¾ç¤º8ä½
            path: path.resolve(__dirname, 'dist'),
            publicPath: 'http://www.mayufo.cn'  // // ç»™æ‰€æœ‰æ‰“åŒ…æ–‡ä»¶å¼•å…¥æ—¶åŠ å‰ç¼€ï¼ŒåŒ…æ‹¬cssï¼Œjsï¼Œimgï¼Œå¦‚æœåªæƒ³å¤„ç†å›¾ç‰‡å¯ä»¥å•ç‹¬åœ¨url-loaderé…ç½®ä¸­åŠ publicPath
        }
    }

æœ¬åœ°æœåŠ¡

npm i webpack-dev-server -D

    devServer: {
        port: 3000,
        progress: true    // æ»šåŠ¨æ¡
        // contentBase: ''  // èµ·æœåŠ¡çš„åœ°å€
        // open: true    // è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
        // compressï¼š true   // å‹ç¼©
    }

å¤åˆ¶html

npm i html-webpack-plugin -D

    let HtmlWebpackPlugin = require('html-webpack-plugin')
    plugins: [ // æ”¾ç€æ‰€æœ‰webpackæ’ä»¶
        new HtmlWebpackPlugin({ // ç”¨äºä½¿ç”¨æ¨¡æ¿æ‰“åŒ…æ—¶ç”Ÿæˆindex.htmlæ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨run devæ—¶ä¼šå°†æ¨¡æ¿æ–‡ä»¶ä¹Ÿæ‰“åŒ…åˆ°å†…å­˜ä¸­
          template: './index.html', // æ¨¡æ¿æ–‡ä»¶
          filename: 'index.html', // æ‰“åŒ…åç”Ÿæˆæ–‡ä»¶
          hash: true, // æ·»åŠ hashå€¼è§£å†³ç¼“å­˜é—®é¢˜
          minify: { // å¯¹æ‰“åŒ…çš„htmlæ¨¡æ¿è¿›è¡Œå‹ç¼©
            removeAttributeQuotes: true, // åˆ é™¤å±æ€§åŒå¼•å·
            collapseWhitespace: true // æŠ˜å ç©ºè¡Œå˜æˆä¸€è¡Œ
          }
        })
    ]
    

html-webpack-plugin#options

å¤„ç†css

npm i css-loader style-loader -D

    module: {    // æ¨¡å—
            rules: [   // è§„åˆ™
                // style-loader æŠŠcssæ’å…¥headæ ‡ç­¾ä¸­
                // loader åŠŸèƒ½å•ä¸€
                // å¤šä¸ªloader éœ€è¦ []
                // é¡ºä¾¿é»˜è®¤ä»å³åˆ°å·¦
                // ä¹Ÿå¯ä»¥å†™æˆå¯¹è±¡æ–¹å¼
                {
                    test: /\.css$/,   // css å¤„ç†
                    // use: 'css-loader'
                    // use: ['style-loader', 'css-loader'],
                    use: [
                        // {
                        //     loader: 'style-loader',
                        //     options: {
                        //         insertAt: 'top' // å°†cssæ ‡ç­¾æ’å…¥æœ€é¡¶å¤´  è¿™æ ·å¯ä»¥è‡ªå®šä¹‰styleä¸è¢«è¦†ç›–
                        //     }
                        // },
                        MiniCssExtractPlugin.loader,
                        'css-loader', // css-loader ç”¨æ¥è§£æ@importè¿™ç§è¯­æ³•,
                        'postcss-loader'
                    ]
                }
            ]
    }

å¤„ç†less

npm i less-loader

    {
        test: /\.less$/,   // less å¤„ç†
        // use: 'css-loader'
        // use: ['style-loader', 'css-loader'],
        use: [
            // {
            //     loader: 'style-loader',
            //     options: {
            //         insertAt: 'top' // å°†cssæ ‡ç­¾æ’å…¥æœ€é¡¶å¤´  è¿™æ ·å¯ä»¥è‡ªå®šä¹‰styleä¸è¢«è¦†ç›–
            //     }
            // },
            MiniCssExtractPlugin.loader,   // è¿™æ ·ç›¸å½“äºæŠ½ç¦»æˆä¸€ä¸ªcssæ–‡ä»¶ï¼Œ å¦‚æœå¸Œæœ›æŠ½ç¦»æˆåˆ†åˆ«ä¸åŒçš„css, éœ€è¦å†å¼•å…¥MiniCssExtractPluginï¼Œå†é…ç½®
            'css-loader', // css-loader ç”¨æ¥è§£æ@importè¿™ç§è¯­æ³•
            'postcss-loader',
            'less-loader' // less-loader less -> css
            // sass node-sass sass-loader
            // stylus stylus-loader
        ]
    }

less-loader

æŠ½ç¦»cssæ–‡ä»¶ï¼Œé€šè¿‡linkå¼•å…¥

yarn add mini-css-extract-plugin -D

mini-css-extract-plugin

    let MiniCssExtractPlugin = require('mini-css-extract-plugin')
    
    // å‹ç¼©css
    
    plugins: [
        new MiniCssExtractPlugin({
            filename: 'css/main.css'
        })
    ]
    
    {
        test: /\.css$/,   // css å¤„ç†
        // use: 'css-loader'
        // use: ['style-loader', 'css-loader'],
        use: [
            // {
            //     loader: 'style-loader',
            //     options: {
            //         insertAt: 'top' // å°†cssæ ‡ç­¾æ’å…¥æœ€é¡¶å¤´  è¿™æ ·å¯ä»¥è‡ªå®šä¹‰styleä¸è¢«è¦†ç›–
            //     }
            // },
            MiniCssExtractPlugin.loader,   // æŠ½ç¦»
            'css-loader', // css-loader ç”¨æ¥è§£æ@importè¿™ç§è¯­æ³•,
            'postcss-loader'
        ]
    }
    

æŠ½ç¦»cssæ’ä»¶æ–‡ä»¶æ—¶å¯ä½¿ç”¨optimize-css-assets-webpack-pluginä¼˜åŒ–å‹ç¼©cssä»¥åŠjsæ–‡ä»¶

å‹ç¼©csså’Œjs

    const OptimizeCSSAssetsPlugin = require("optimize-css-assets-webpack-plugin")
    const UglifyJsPlugin = require("uglifyjs-webpack-plugin")
    
    optimization: {   // ä¼˜åŒ–é¡¹ç›®
        minimizer: [
            new UglifyJsPlugin({     // ä¼˜åŒ–js
                cache: true,   // æ˜¯å¦ç¼“å­˜
                parallel: true,   // æ˜¯å¦å¹¶å‘
                // sourceMap: true // æºç æ˜ å°„ set to true if you want JS source maps
            }),
            new OptimizeCSSAssetsPlugin({})    // css çš„ä¼˜åŒ–
        ]
    }
    

ç»™cssåŠ ä¸Šå…¼å®¹æµè§ˆå™¨çš„å‰ç¼€

yarn add postcss-loader autoprefixer -D

    // css
    {
        test: /\.css$/,   // css å¤„ç†
        // use: 'css-loader'
        // use: ['style-loader', 'css-loader'],
        use: [
            // {
            //     loader: 'style-loader',
            //     options: {
            //         insertAt: 'top' // å°†cssæ ‡ç­¾æ’å…¥æœ€é¡¶å¤´  è¿™æ ·å¯ä»¥è‡ªå®šä¹‰styleä¸è¢«è¦†ç›–
            //     }
            // },
            MiniCssExtractPlugin.loader,
            'css-loader', // css-loader ç”¨æ¥è§£æ@importè¿™ç§è¯­æ³•,
            'postcss-loader'
        ]
    }
    // less
    {
        test: /\.less$/,   // less å¤„ç†
        // use: 'css-loader'
        // use: ['style-loader', 'css-loader'],
        use: [
            // {
            //     loader: 'style-loader',
            //     options: {
            //         insertAt: 'top' // å°†cssæ ‡ç­¾æ’å…¥æœ€é¡¶å¤´  è¿™æ ·å¯ä»¥è‡ªå®šä¹‰styleä¸è¢«è¦†ç›–
            //     }
            // },
            MiniCssExtractPlugin.loader,   // è¿™æ ·ç›¸å½“äºæŠ½ç¦»æˆä¸€ä¸ªcssæ–‡ä»¶ï¼Œ å¦‚æœå¸Œæœ›æŠ½ç¦»æˆåˆ†åˆ«ä¸åŒçš„css, éœ€è¦å†å¼•å…¥MiniCssExtractPluginï¼Œå†é…ç½®
            'css-loader', // css-loader ç”¨æ¥è§£æ@importè¿™ç§è¯­æ³•
            'postcss-loader',
            'less-loader' // less-loader less -> css
            // sass node-sass sass-loader
            // stylus stylus-loader
        ]
    },

postcss éœ€è¦é…ç½®æ–‡æ¡£   postcss.config1.js

postcss-loader

    module.exports = {
        plugins: [
            require('autoprefixer')
        ]
    }



es6 è½¬ es5

npm i babel-loader @babel/core  @babel/preset-env -D

    {
        test: /\.js$/,
        use: {
            loader: 'babel-loader',
            options: {
                presets: [
                    '@babel/preset-env'
                ],
                plugins:[
                    ["@babel/plugin-proposal-decorators", { "legacy": true }],
                    ["@babel/plugin-proposal-class-properties", { "loose" : true }]
                ]
            }
        }
    }

es7çš„è¯­æ³•

    // class
    npm i @babel/plugin-proposal-class-properties -D
    // è£…é¥°å™¨
    npm i @babel/plugin-proposal-decorators -D

é…ç½®å¦‚ä¸Š

å…¨å±€å˜é‡å¼•å…¥

jqueryçš„å¼•å…¥

    npm i jquery -S

    let webpack = require('webpack')
    
    new webpack.ProvidePlugin({
      $: 'jquery'
    })

å…¶ä»–æƒ…å†µ

1. æš´éœ²å…¨å±€

npm i expose-loader -D æš´éœ²å…¨å±€çš„loader

å¯ä»¥åœ¨jsä¸­ import $ from 'expose-loader?$!jquery'   // å…¨å±€æš´éœ²jqueryä¸º$ç¬¦å·

å¯ä»¥è°ƒç”¨window.$

ä¹Ÿå¯åœ¨webpack.config.js ä¸­é…ç½® rules

    {
        test: require.resolve('jquery'),
        use: 'expose-loader?$'
    }

ä»¥ååœ¨.jsæ–‡ä»¶ä¸­å¼•å…¥

    import $ from 'jquery'

1. å¦‚ä½•åœ¨æ¯ä¸ªæ¨¡å—ä¸­æ³¨å…¥

    let webpack = require('webpack')
    
    // åœ¨pluginsä¸­é…ç½®
    new webpack.ProvidePlugin({
        $: 'jquery'
    })

1. åœ¨index.htmlä¸­é€šè¿‡scriptæ ‡ç­¾å¼•å…¥jquery, ä½†æ˜¯åœ¨jsä¸­ï¼Œç”¨importä¼šé‡æ–°æ‰“åŒ…jquery,å¦‚ä½•é¿å…

ä»è¾“å‡ºçš„bundle ä¸­æ’é™¤ä¾èµ–

     externals: {
      jquery: 'jQuery'
     }

æ­¤æ—¶åœ¨index.jsä¸Š

    import $ from 'jquery'
    
    console.log($, 123456)   // å¯ä»¥æ­£å¸¸è¿è¡Œ

webpackå›¾ç‰‡æ‰“åŒ…

1. jsä¸­åˆ›å»º
2. cssä¸­å¼•å…¥
3. <img src="">

yarn add file-loader -D

é€‚åˆä¸€äºŒæƒ…å†µ

    {
        test: /\.(png|jpg|gif)$/,
        // å½“å›¾ç‰‡å°äºå¤šå°‘ï¼Œç”¨base64,å¦åˆ™ç”¨file-loaderäº§ç”ŸçœŸå®çš„å›¾ç‰‡
        use: {
            loader: 'url-loader',
            options: {
                limit: 1,  // 200k 200 * 1024
                outputPath: '/img/',   // æ‰“åŒ…åè¾“å‡ºåœ°å€
                publicPath: 'http://www.mayufo.cn'
            }
        }
    }

é»˜è®¤ä¼šå†…éƒ¨ç”Ÿæˆä¸€å¼ å›¾ç‰‡åˆ°build,ç”Ÿæˆå›¾ç‰‡çš„è·¯å¾„è¿”å›å›æ¥

ç¬¬ä¸€ç§æƒ…å†µ: å›¾ç‰‡åœ°å€è¦importå¼•å…¥ï¼Œç›´æ¥å†™å›¾ç‰‡çš„åœ°å€ï¼Œä¼šé»˜è®¤ä¸ºå­—ç¬¦ä¸²

    import logo from './logo.png'
    
    console.log(logo)
    let image = new Image()
    
    image.src = logo
    
    document.body.appendChild(image)

ç¬¬äºŒç§æƒ…å†µ: css-loaderä¼šå°†cssé‡Œé¢çš„å›¾ç‰‡è½¬ä¸ºrequireçš„æ ¼å¼

    div {
        background: url("./logo.png");
       }

ç¬¬ä¸‰ç§æƒ…å†µ: è§£æhtmlä¸­çš„image

yarn add html-withimg-loader -D

    {
        test: /\.html$/,
        use: 'html-withimg-loader'
    }

å½“å›¾ç‰‡å°äºå¤šå°‘ï¼Œç”¨base64

yarn add url-loader -D

å¦‚æœè¿‡å¤§ï¼Œæ‰ç”¨file-loader

    {
        test: /\.(png|jpg|gif)$/,
        // å½“å›¾ç‰‡å°äºå¤šå°‘ï¼Œç”¨base64,å¦åˆ™ç”¨file-loaderäº§ç”ŸçœŸå®çš„å›¾ç‰‡
        use: {
            loader: 'url-loader',
            options: {
                limit: 1,  // 200k 200 * 1024
                outputPath: '/img/',   // æ‰“åŒ…åè¾“å‡ºåœ°å€
                publicPath: 'http://www.mayufo.cn'
            }
        }
    }

æ‰“åŒ…æ–‡ä»¶åˆ†ç±»

å›¾ç‰‡

     {
        test: /\.(png|jpg|gif)$/,
        // å½“å›¾ç‰‡å°äºå¤šå°‘ï¼Œç”¨base64,å¦åˆ™ç”¨file-loaderäº§ç”ŸçœŸå®çš„å›¾ç‰‡
        use: {
            loader: 'url-loader',
            options: {
                limit: 1,  // 200k 200 * 1024
                outputPath: 'img/'   // æ‰“åŒ…åè¾“å‡ºåœ°å€ åœ¨dist/img
            }
        }
     },

css

    plugins: [
     new MiniCssExtractPlugin({
                filename: 'css/main.css'
            }),
    ]

å¸Œæœ›è¾“å‡ºçš„æ—¶å€™ï¼Œç»™è¿™äº›css\imgåŠ ä¸Šå‰ç¼€ï¼Œä¼ åˆ°æœåŠ¡å™¨ä¹Ÿèƒ½è®¿é—®

    output: {
        filename: 'bundle.[hash:8].js',   // hash: 8åªæ˜¾ç¤º8ä½
        path: path.resolve(__dirname, 'dist'),
        publicPath: 'http://www.mayufo.cn'  // ç»™é™æ€èµ„æºç»Ÿä¸€åŠ 
    },

å¦‚æœåªå¸Œæœ›å¤„ç†å›¾ç‰‡

    {
        test: /\.(png|jpg|gif)$/,
        // å½“å›¾ç‰‡å°äºå¤šå°‘ï¼Œç”¨base64,å¦åˆ™ç”¨file-loaderäº§ç”ŸçœŸå®çš„å›¾ç‰‡
        use: {
            loader: 'url-loader',
            options: {
                limit: 1,  // 200k 200 * 1024
                outputPath: '/img/',   // æ‰“åŒ…åè¾“å‡ºåœ°å€
                publicPath: 'http://www.mayufo.cn'
            }
        }
    }

æ‰“åŒ…å¤šé¡µåº”ç”¨

    // å¤šå…¥å£
    let path = require('path')
    let HtmlWebpackPlugin = require('html-webpack-plugin')
    
    module.exports = {
        mode: 'development',
        entry: {
            home: './src/index.js',
            other: './src/other.js'
        },
        output: {
            filename: "[name].js",
            path: path.resolve(__dirname, 'dist2')
        },
        plugins: [
            new HtmlWebpackPlugin({
                template: './index.html',
                filename: 'home.html',
                chunks: ['home']
            }),
            new HtmlWebpackPlugin({
                template: './index.html',
                filename: 'other.html',
                chunks: ['other', 'home']   // other.html é‡Œé¢æœ‰ other.js & home.js
            }),
        ]
    }
    

é…ç½®source-map

yarn add @babel/core  @babel/preset-env babel-loader  webpack-dev-server -D

devtool: 'source-map' // å¢åŠ æ˜ å°„æ–‡ä»¶è°ƒè¯•æºä»£ç 

1. æºç æ˜ å°„ ä¼šæ ‡è¯†é”™è¯¯çš„ä»£ç  æ‰“åŒ…åç”Ÿæˆç‹¬ç«‹çš„æ–‡ä»¶ å¤§è€Œå…¨ ã€Œsource-mapã€
2. ä¸ä¼šé™ˆèƒœå•ç‹¬çš„æ–‡ä»¶ ä½†æ˜¯å¯ä»¥æ˜¾ç¤ºè¡Œå’Œåˆ—  ã€Œevl-source-mapã€
3. ä¸ä¼šäº§ç”Ÿåˆ—ï¼Œäº§ç”Ÿå•ç‹¬çš„æ˜ å°„æ–‡ä»¶  ã€Œcheap-module-source-mapã€
4. ä¸ä¼šäº§ç”Ÿæ–‡ä»¶ é›†æˆåœ¨æ‰“åŒ…åçš„æ–‡ä»¶ä¸­ ä¸ä¼šäº§ç”Ÿåˆ— ã€Œcheap-module-eval-source-mapã€

watch æ”¹å®Œä»£è¡¨é‡æ–°æ‰“åŒ…å®ä½“

    watch: true,
    watchOptions: {
        poll: 1000,   // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡å˜åŠ¨
        aggregateTimeout: 300,  // å½“ç¬¬ä¸€ä¸ªæ–‡ä»¶æ›´æ”¹ï¼Œä¼šåœ¨é‡æ–°æ„å»ºå‰å¢åŠ å»¶è¿Ÿ
        ignored: /node_modules/  // å¯¹äºæŸäº›ç³»ç»Ÿï¼Œç›‘å¬å¤§é‡æ–‡ä»¶ç³»ç»Ÿä¼šå¯¼è‡´å¤§é‡çš„ CPU æˆ–å†…å­˜å ç”¨ã€‚è¿™ä¸ªé€‰é¡¹å¯ä»¥æ’é™¤ä¸€äº›å·¨å¤§çš„æ–‡ä»¶å¤¹ï¼Œ
    },

webpackçš„å…¶ä»–ä¸‰ä¸ªå°æ’ä»¶

1. cleanWebpackPlugin

æ¯æ¬¡æ‰“åŒ…ä¹‹å‰åˆ æ‰distç›®å½•

yarn add clean-webpack-plugin -D

clean-webpack-plugin

    const CleanWebpackPlugin = require('clean-webpack-plugin');
    output: {
        path: path.resolve(process.cwd(), 'dist'),
    },
    plugins: [
        new CleanWebpackPlugin()
    ]
    

1. copyWebpackPlugin

ä¸€äº›é™æ€èµ„æºä¹Ÿå¸Œæœ›æ‹·è´çš„distä¸­

yarn add copy-webpack-plugin -D

    const CopyWebpackPlugin = require('copy-webpack-plugin')
    
    const config = {
      plugins: [
         new CopyWebpackPlugin([
        {from: './src/doc', to: './public'}
        ])
      ]
    }
    

1. bannerPluginå†…ç½®æ¨¡å—

ç‰ˆæƒå£°æ˜

    const webpack = require('webpack');
    
    new webpack.BannerPlugin('hello world')
    // or
    new webpack.BannerPlugin({ banner: 'hello world'})
    
    

webpack è·¨åŸŸ

è®¾ç½®ä¸€ä¸ªæœåŠ¡,ç”±äºwebpack-dev-serverå†…å«express

express

server.js

    // express
    
    let express = require('express')
    
    let app = express();
    
    app.get('/api/user', (res) => {
        res.json({name: 'mayufo'})
    })
    
    app.listen(3000)   // æœåŠ¡ç«¯å£åœ¨3000
    

å†™å®Œåè®°å¾—node server.js

è®¿é—® http://localhost:3000/api/user å¯è§å†…å®¹

index.js

    // å‘é€ä¸€ä¸ªè¯·æ±‚
    let xhr = new XMLHttpRequest();
    
    // é»˜è®¤è®¿é—® http://localhost:8080  webpack-dev-server çš„æœåŠ¡ å†è½¬å‘ç»™3000
    xhr.open('GET', '/api/user', true);
    
    xhr.onload = function () {
        console.log(xhr.response)
    }
    
    xhr.send();
    
    

webpack.config.js

    devServer: {
      proxy: {
          '/api': 'http://localhost:3000' // é…ç½®ä¸€ä¸ªä»£ç†
      }
    },
    

å¦‚æœåç«¯ç»™çš„è¯·æ±‚æ²¡æœ‰API ã€Œè·¨åŸŸã€

    // express
    
    let express = require('express')
    
    let app = express();
    
    
    app.get('/user', (res) => {
        res.json({name: 'mayufo'})
    })
    
    app.listen(3000)   // æœåŠ¡ç«¯å£åœ¨3000
    

è¯·æ±‚å·²apiå¼€å¤´, è½¬å‘çš„æ—¶å€™å†åˆ æ‰api

    devServer: {
        proxy: {
            '/api': {
                target: 'http://localhost:3000',
                pathRewrite: {'^/api': ''}
            }
        }
    }
    

å‰ç«¯åªæƒ³å•çº¯mockæ•°æ® ã€Œè·¨åŸŸã€

    devServer: {
        // proxy: {
        //     '/api': 'http://localhost:3000' // é…ç½®ä¸€ä¸ªä»£ç†
        // }
        //   proxy: {   // é‡å†™æ–¹å¼ æŠŠè¯·æ±‚ä»£ç†åˆ°express ä¸Š
        //       '/api': {
        //           target: 'http://localhost:3000',
        //           pathRewrite: {'^/api': ''}
        //       }
        //   }
        before: function (app) {  // å‹¾å­
            app.get('/api/user', (req, res) => {
                res.json({name: 'mayufo - before'})
            })
        }
    },
    

æœ‰æœåŠ¡ç«¯ï¼Œä¸ç”¨ä»£ç†, æœåŠ¡ç«¯å¯åŠ¨webpack ã€Œè·¨åŸŸã€

server.jsä¸­å¯åŠ¨webpack

yarn add webpack-dev-middleware -D

server.js

    // express
    
    let express = require('express')
    let webpack = require('webpack')
    let app = express();
    
    
    // ä¸­é—´ä»¶
    let middle = require('webpack-dev-middleware')
    
    let config = require('./webpack.config')
    
    
    let compiler = webpack(config)
    
    
    app.use(middle(compiler))
    
    app.get('/user', (req, res) => {
        res.json({name: 'mayufo'})
    })
    
    
    app.listen(3000)
    
    

webpackè§£æresolve

ä»¥bootstrapä¸ºä¾‹

    npm install bootstrap  -D
    

index.js

    import 'bootstrap/dist/css/bootstrap.css'
    

æŠ¥é”™

    ERROR in ./node_modules/bootstrap/dist/css/bootstrap.css 7:0
    Module parse failed: Unexpected token (7:0)
    You may need an appropriate loader to handle this file type.
    |  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
    |  */
    > :root {
    |   --blue: #007bff;
    |   --indigo: #6610f2;
     @ ./src/index.js 22:0-42
     @ multi (webpack)-dev-server/client?http://localhost:8081 ./src/index.js
    
    

è¿™æ˜¯å› ä¸ºbootstrap 4.0çš„csså¼•å…¥äº†æ–°çš„ç‰¹æ€§ï¼ŒCSS Variables

å®‰è£…

npm install postcss-custom-properties --save-dev

é…ç½®webpack.config.js

    {
        test: /\.css$/,
        use: ['style-loader', 'css-loader', {
            loader: 'postcss-loader',
            options: {
                plugins: (loader) => [
                    require("postcss-custom-properties")
                ]
            }
        }]
    }
    

ä½†æ˜¯æ¯æ¬¡å¼•å…¥éƒ½å¾ˆé•¿ï¼Œå¦‚ä½•ä¼˜é›…å¼•å…¥

    resolve: {
        // åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾
        modules: [path.resolve('node_modules')],
        alias: {
            'bootstrapCss': 'bootstrap/dist/css/bootstrap.css'
        }
    },
    

    import 'bootstrapCss'  // åœ¨node_modulesæŸ¥æ‰¾
    

çœç•¥æ‰©å±•å

    resolve: {
        // åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾
        modules: [path.resolve('node_modules')],
        // alias: {
        //     'bootstrapCss': 'bootstrap/dist/css/bootstrap.css'
        // },
        mainFields: ['style', 'main'],   // å…ˆç”¨bootstrapä¸­åœ¨packageä¸­çš„style,æ²¡æœ‰åœ¨ç”¨main
        // mainFiles: []  // å…¥å£æ–‡ä»¶çš„åå­— é»˜è®¤index
        extensions: ['.js', '.css', '.json']  // å½“æ²¡æœ‰æ‹“å±•å‘½çš„æ—¶å€™ï¼Œå…ˆé»˜è®¤jsã€æ¬¡ä¹‹cssã€å†æ¬¡ä¹‹json
    },
    

å®šä¹‰ç¯å¢ƒå˜é‡

DefinePlugin å…è®¸åˆ›å»ºä¸€ä¸ªåœ¨ç¼–è¯‘æ—¶å¯ä»¥é…ç½®çš„å…¨å±€å¸¸é‡ã€‚è¿™å¯èƒ½ä¼šå¯¹å¼€å‘æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼çš„æ„å»ºå…è®¸ä¸åŒçš„è¡Œä¸ºéå¸¸æœ‰ç”¨ã€‚

    let url = ''
    if (DEV === 'dev') {
        // å¼€å‘ç¯å¢ƒ
        url = 'http://localhost:3000'
    } else {
        // ç”Ÿæˆç¯å¢ƒ
        url = 'http://www.mayufo.cn'
    }
    

webpack.config.js

    new webpack.DefinePlugin({
        // DEV: '"production"',
        DEV: JSON.stringify('production'),
        FLAG: 'true',   // å¸ƒå°”
        EXPRESSION: '1 + 1'   // å­—ç¬¦ä¸² å¦‚æœå¸Œæœ›æ˜¯å­—ç¬¦ä¸² JSON.stringify('1 + 1')
    })
    

åŒºåˆ†ä¸¤ä¸ªä¸åŒçš„ç¯å¢ƒ

åˆ†åˆ«é…ç½®ä¸åŒçš„ç¯å¢ƒ

- webpack.base4.js   åŸºç¡€é…ç½®
- webpack.dev4.js    å¼€å‘ç¯å¢ƒ
- webpack.prod4.js   ç”Ÿäº§ç¯å¢ƒ

yarn add webpack-merge -D

npx run build -- config webpack.dev4.js

npx run build -- config webpack.build.js

å®˜æ–¹æ–‡æ¡£

webpack.base4.js

    let path = require('path')
    let HtmlWebpackPlugin = require('html-webpack-plugin')
    let CleanWebpackPlugin = require('clean-webpack-plugin')
    
    module.exports = {
        entry: {
            home: './src/index.js'
        },
        output: {
            filename: "[name].js",
            path: path.resolve(process.cwd(), 'dist3')
        },
        module: {
            rules: [
                {
                    test: /\.js$/,
                    use: {
                        loader: 'babel-loader',
                        options: {
                            presets: [
                                '@babel/preset-env'
                            ]
                        }
                    }
                },
                {
                    test: /\.css$/,
                    use: ['style-loader', 'css-loader', {
                        loader: 'postcss-loader',
                        options: {
                            plugins: (loader) => [
                                require("postcss-custom-properties")
                            ]
                        }
                    }]
                }
            ]
        },
        plugins: [
            new HtmlWebpackPlugin({
                template: './src/index.html',
                filename: 'index.html'
            })
        ]
    }
    
    

webpack.dev4.js

    let merge = require('webpack-merge')
    let base = require('./webpack.base4.js')
    
    
    module.exports = merge(base, {
        mode: 'development',
        devServer: {},
        devtool: 'source-map'
    })
    
    

webpack.prod4.js

    let merge = require('webpack-merge')
    let base = require('./webpack.base4.js')
    
    
    module.exports = merge(base, {
        mode: 'production'
    })
    
    

package.json

    "scripts": {
        "build": "webpack-dev-server  --config webpack.prod4.js",
        "dev": "webpack-dev-server --config webpack.dev4.js"
    },
    

webpack ä¼˜åŒ–

yarn add webpack webpack-cli html-webpack-plugin @babel/core babel-loader @babel/preset-env @babel/preset-react -D

webpack.config.js

    let path = require('path')
    let HtmlWebpackPlugin = require('html-webpack-plugin')
    
    
    module.exports = {
        mode: 'development',
        entry: './src/index.js',
        output: {
            filename: 'main.js',
            path: path.resolve(__dirname, 'dist')
        },
        module: {
          rules: [
              {
                  test: /\.js$/,
                  use: {
                      loader: 'babel-loader',
                      options: {
                          presets: [
                              '@babel/preset-env',
                              '@babel/preset-react'
                          ]
                      }
                  }
              },
          ]
        },
        plugins: [
            new HtmlWebpackPlugin({
                template: './src/index.html',
                filename: 'index.html'
            }),
        ]
    }
    
    

ä¼˜åŒ–ï¼šå½“æŸäº›åŒ…æ˜¯ç‹¬ç«‹çš„ä¸ªä½“æ²¡æœ‰ä¾èµ–

ä»¥jqueryä¸ºä¾‹ï¼Œyarn add jquery -D,å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŒ…æ²¡æœ‰ä¾èµ–ï¼Œå¯ä»¥åœ¨webpacké…ç½®ä¸­ï¼Œé…ç½®å®ƒä¸å†æŸ¥æ‰¾ä¾èµ–

    module: {
        noParse: /jquery/, // ä¸ç”¨è§£ææŸäº›åŒ…çš„ä¾èµ–
        rules: [
          {
              test: /\.js$/,
              use: {
                  loader: 'babel-loader',
                  options: {
                      presets: [
                          '@babel/preset-env',
                          '@babel/preset-react'
                      ]
                  }
              }
          },
      ]
    },
    

è¿è¡Œnpx webpack

ä»2057ms  -> 1946 ms

ä¼˜åŒ–ï¼šè§„åˆ™åŒ¹é…è®¾ç½®èŒƒå›´

    rules: [
      {
          test: /\.js$/,
          exclude: '/node_modules/',   // æ’é™¤
          include: path.resolve('src'),  // åœ¨è¿™ä¸ªèŒƒå›´å†…
          use: {
              loader: 'babel-loader',
              options: {
                  presets: [
                      '@babel/preset-env',
                      '@babel/preset-react'
                  ]
              }
          }
      }
    

å°½é‡å®ç”¨include,ä¸ä½¿ç”¨exclude,ä½¿ç”¨ç»å¯¹è·¯å¾„

ä¼˜åŒ–ï¼šå¿½ç•¥ä¾èµ–ä¸­ä¸å¿…è¦çš„è¯­è¨€åŒ…

yarn add moment webpack-dev-server -D

å¿½ç•¥æ‰momentçš„å…¶ä»–è¯­è¨€åŒ…

    let webpack = require('webpack')
    
    plugins: [
        new webpack.IgnorePlugin(/\.\/locale/, /moment/)
    ]
    
    

index.js

    import moment from 'moment'
    
    let r = moment().endOf('day').fromNow()  // è·ç¦»ç°åœ¨å¤šå°‘å¤©
    console.log(r);
    

ä» 1.2MB åˆ°  800kb

åŠ¨æ€é“¾æ¥åº“

yarn add react react-dom

æ­£å¸¸ä½¿ç”¨

webpack.config.js

    {
      test: /\.js$/,
      exclude: '/node_modules/',
      include: path.resolve('src'),
      use: {
          loader: 'babel-loader',
          options: {
              presets: [
                  '@babel/preset-env',
                  '@babel/preset-react'
              ]
          }
      }
    }
    

index.js

    import React from 'react'
    
    import {render} from 'react-dom'
    
    
    render(<h1>111111</h1>, window.root)
    

index.html

    <div id="root"></div>
    

ç‹¬ç«‹çš„å°†react react-dom æ‰“åŒ…å¥½, æ‰“åŒ…å¥½å†å¼•ç”¨ï¼Œä»è€Œå‡å°‘webpackæ¯æ¬¡éƒ½è¦æ‰“åŒ…react

åˆ›å»ºwebpack.config.react.js

    let path = require('path')
    let webpack = require('webpack')
    module.exports = {
        mode: 'development',
        entry: {
            // test: './src/test.js'
            react: ['react', 'react-dom']
        },
        output: {
            filename: '_dll_[name].js',  // äº§ç”Ÿçš„æ–‡ä»¶å
            path: path.resolve(__dirname, 'dist'),
            library: '_dll_[name]',     // ç»™è¾“å‡ºçš„ç»“æœåŠ ä¸ªåå­—
            // libraryTarget: 'var'   // é…ç½®å¦‚ä½•æš´éœ² library
            // commonjs ç»“æœæ”¾åœ¨exportå±æ€§ä¸Šï¼Œ umdç»Ÿä¸€èµ„æºæ¨¡å—, é»˜è®¤æ˜¯var
        },
        plugins: [
           new webpack.DllPlugin({
               name: '_dll_[name]',   // name === library
               path: path.resolve(__dirname, 'dist', 'manifest.json')  // manifest.json å®šä¹‰äº†å„ä¸ªæ¨¡å—çš„è·¯å¾„
           })
        ]
    }
    

libraryTarget

manifest.jsonå°±æ˜¯ä¸€ä¸ªä»»åŠ¡æ¸…å•oråŠ¨æ€é“¾æ¥åº“ï¼Œåœ¨è¿™ä¸ªæ¸…å•é‡Œé¢æŸ¥æ‰¾react

npx webpack --config webpack.config.react.js

åœ¨index.htmlå¢åŠ å¼•ç”¨

    <body>
    <div id="root"></div>
    <script src="/_dll_react.js"></script>
    </body>
    

åœ¨webpack.config.js ä¸­é…ç½®ï¼Œç°åœ¨åŠ¨æ€é“¾æ¥åº“manifest.jsonä¸­æŸ¥æ‰¾,å¦‚æœæ²¡æœ‰å†æ‰“åŒ…react

    plugins: [
        new webpack.DllReferencePlugin({
            manifest: path.resolve(__dirname, 'dist', 'manifest.json')
        })
    ]
    
    

DLLPlugin å’Œ DLLReferencePlugin

npm run build

æ‰“åŒ…åçš„bunle.jsæ–‡ä»¶å˜å°

npm run dev

å¯ä»¥ç†è§£ä¸ºå…ˆæŠŠreactæ‰“åŒ…ï¼Œåé¢æ¯æ¬¡éƒ½ç›´æ¥ä½¿ç”¨reactæ‰“åŒ…åçš„ç»“æœ

å¤šçº¿ç¨‹æ‰“åŒ…happypack

yarn add happypack

webpack.config.js

    let Happypack = require('happypack')
    
    
    rules: [
        {
            test: /\.js$/,
            exclude: '/node_modules/',
            include: path.resolve('src'),
            use: 'happypack/loader?id=js'
        },
    ]
    
    plugins: [
        new Happypack({
            id: 'js',
            use: [{
                loader: 'babel-loader',
                options: {
                    presets: [
                        '@babel/preset-env',
                        '@babel/preset-react'
                    ]
                }
            }]
        })
    ]
    

jså¯ç”¨å¤šçº¿ç¨‹ï¼Œç”±äºå¯ç”¨å¤šçº¿ç¨‹ä¹Ÿä¼šæµªè´¹æ—¶é—´ï¼Œå› æ­¤å½“é¡¹ç›®æ¯”è¾ƒå¤§çš„æ—¶å€™å¯ç”¨æ•ˆæœæ›´å¥½

csså¯ç”¨å¤šçº¿ç¨‹

    {
        test: /\.css$/,
        use: 'happypack/loader?id=css'
    }
    
     new Happypack({
        id: 'css',
        use: ['style-loader', 'css-loader']
    }),
    

webpack è‡ªå¸¦çš„ä¼˜åŒ–

test.js

    let sum = (a, b) => {
        return a + b + 'sum'
    }
    
    let minus = (a, b) => {
        return a - b + 'minus';
    }
    
    export default {
     sum, minus
    }
    

1. ä½¿ç”¨import 

index.js

    import calc from './test'
    
    console.log(calc.sum(1, 2));
    

importåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä¼šè‡ªåŠ¨å»é™¤æ²¡æœ‰ç”¨çš„ä»£ç minusï¼Œè¿™å«tree-shakingï¼Œå°†æ²¡æœ‰ç”¨çš„ä»£ç è‡ªåŠ¨åˆ é™¤æ‰

index.js

    let calc = require('./test')
    console.log(calc);   // es 6å¯¼å‡ºï¼Œæ˜¯ä¸€ä¸ªdefaultçš„å¯¹è±¡
    console.log(calc.default.sum(1, 2));
    

requireå¼•å…¥es6 æ¨¡å—ä¼šæŠŠç»“æœæ”¾åœ¨defaultä¸Š,æ‰“åŒ…buildåå¹¶ä¸ä¼šæŠŠå¤šä½™minusä»£ç åˆ é™¤æ‰ï¼Œä¸æ”¯æŒtree-shaking

1. ä½œç”¨åŸŸçš„æå‡

index.js

    let a = 1
    let b = 2
    let c = 3
    let d = a + b + c
    
    console.log(d, '---------');
    

æ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶

    console.log(r.default.sum(1,2));console.log(6,"---------")
    

åœ¨webpackä¸­å¯ä»¥çœç•¥ä¸€äº›å¯ä»¥ç®€åŒ–çš„ä»£ç 

æŠ½å–å…¬å…±ä»£ç 

1. æŠ½ç¦»è‡ªæœ‰æ¨¡å—

webpack.config.js

    optimization: {
        splitChunks: {  // åˆ†å‰²ä»£ç å—ï¼Œé’ˆå¯¹å¤šå…¥å£
            cacheGroups: {   // ç¼“å­˜ç»„
                common: {   // å…¬å…±æ¨¡å—
                    minSize: 0,  // å¤§äºå¤šå°‘æŠ½ç¦»
                    minChunks: 2,  // ä½¿ç”¨å¤šå°‘æ¬¡ä»¥ä¸ŠæŠ½ç¦»æŠ½ç¦»
                    chunks: 'initial'  // ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹,åˆšå¼€å§‹
                }
            }
        }
    },
    

SplitChunksPlugin

åˆ†åˆ«æœ‰a.jså’Œb.js, index.jså’Œother.jsåˆ†åˆ«å¼•å…¥aå’Œbä¸¤ä¸ªjs

index.js

    import './a'
    import './b'
    
    console.log('index.js');
    

other.js

    import './a'
    import './b'
    
    console.log('other.js');
    

webpack.config.js

    optimization: {
        splitChunks: {  // åˆ†å‰²ä»£ç å—ï¼Œé’ˆå¯¹å¤šå…¥å£
            cacheGroups: {   // ç¼“å­˜ç»„
                common: {   // å…¬å…±æ¨¡å—
                    minSize: 0,  // å¤§äºå¤šå°‘æŠ½ç¦»
                    minChunks: 2,  // ä½¿ç”¨å¤šå°‘æ¬¡ä»¥ä¸ŠæŠ½ç¦»æŠ½ç¦»
                    chunks: 'initial'  // ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹,åˆšå¼€å§‹
                }
            }
        },
    },
    

1. æŠ½ç¦»ç¬¬ä¸‰æ–¹æ¨¡å—

æ¯”å¦‚jquery

index.js å’Œ other.jsåˆ†åˆ«å¼•å…¥

    import $ from 'jquery'
    
    console.log($);
    

webpack.config.js

    optimization: {
        splitChunks: {  // åˆ†å‰²ä»£ç å—ï¼Œé’ˆå¯¹å¤šå…¥å£
            cacheGroups: {   // ç¼“å­˜ç»„
                common: {   // å…¬å…±æ¨¡å—
                    minSize: 0,  // å¤§äºå¤šå°‘æŠ½ç¦»
                    minChunks: 2,  // ä½¿ç”¨å¤šå°‘æ¬¡ä»¥ä¸ŠæŠ½ç¦»æŠ½ç¦»
                    chunks: 'initial'  // ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹,åˆšå¼€å§‹
                },
                vendor: {
                    priority: 1, // å¢åŠ æƒé‡,å…ˆæŠ½ç¦»ç¬¬ä¸‰æ–¹
                    test: /node_modules/,
                    minSize: 0,  // å¤§äºå¤šå°‘æŠ½ç¦»
                    minChunks: 2,  // ä½¿ç”¨å¤šå°‘æ¬¡ä»¥ä¸ŠæŠ½ç¦»æŠ½ç¦»
                    chunks: 'initial'  // ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹,åˆšå¼€å§‹
                }
            }
        },
    },
    

æ‡’åŠ è½½(å»¶è¿ŸåŠ è½½)

yarn add @babel/plugin-syntax-dynamic-import  -D

source.js

    export default 'mayufo'
    

index.js

    let button = document.createElement('button')
    
    button.innerHTML = 'may'
    button.addEventListener('click', function () {
        console.log('click')
        // es6è‰æ¡ˆä¸­çš„è¯­æ³•ï¼Œjsonpå®ç°åŠ¨æ€åŠ è½½æ–‡ä»¶
        import('./source.js').then(data => {
            console.log(data.default);
        })
    })
    
    
    document.body.appendChild(button)
    
    

webpack.config.js

    {
        test: /\.js$/,
        exclude: '/node_modules/',
        include: path.resolve('src'),
        use: [{
            loader: 'babel-loader',
            options: {
                presets: [
                    '@babel/preset-env',
                    '@babel/preset-react'
                ],
                plugins: [
                    '@babel/plugin-syntax-dynamic-import'
                ]
            }
        }]
    }
    

çƒ­æ›´æ–°(å½“é¡µé¢æ”¹å˜åªæ›´æ–°æ”¹å˜çš„éƒ¨åˆ†ï¼Œä¸é‡æ–°æ‰“åŒ…)

webpack.config.js

    plugins: [
        new HtmlWebpackPlugin({
            template: './src/index.html',
            filename: 'index.html'
        }),
        new webpack.NameModulesPlugin(), // æ‰“å°æ›´æ–°çš„æ¨¡å—è·¯å¾„
        new webpack.HotModuleReplacementPlugin()
    ]
    

index.js

    import str from './source'
    
    console.log(str);
    
    if (module.hot) {
        module.hot.accept('./source', () => {
            console.log('æ–‡ä»¶æ›´æ–°äº†');
            require('./source')
            console.log(str);
        })
    }
    
    

tapableä»‹ç» - SyncHook

tapable

webpackæœ¬è´¨ä¸Šæ˜¯ä¸€ç§äº‹ä»¶æµçš„æœºåˆ¶ï¼Œå®ƒçš„å·¥ä½œæµç¨‹å°±æ˜¯å°†å„ä¸ªæ’ä»¶ä¸²è”èµ·æ¥ï¼Œè€Œå®ç°è¿™ä¸€åˆ‡çš„æ ¸å¿ƒå°±æ˜¯Tapableï¼Œwebpackä¸­æœ€æ ¸å¿ƒçš„è´Ÿè´£ç¼–è¯‘çš„Compilerå’Œè´Ÿè´£åˆ›å»ºbundlesçš„Compilationéƒ½æ˜¯Tapableçš„å®ä¾‹ã€‚

SyncHook ä¸å…³å¿ƒç›‘å¬å‡½æ•°çš„è¿”å›å€¼

yarn add tabable

1.use.js

    let {SyncHook} = require('tapable')   // ç»“æ„åŒæ­¥å‹¾å­
    
    
    class Lesson {
        constructor () {
            this.hooks = {
                // è®¢é˜…å‹¾å­
                arch: new SyncHook(['name']),
    
            }
        }
        start () {
            this.hooks.arch.call('may')
        }
        tap () {   //  æ³¨å†Œç›‘å¬å‡½æ•°
            this.hooks.arch.tap('node', function (name) {
                console.log('node', name)
            })
            this.hooks.arch.tap('react', function (name) {
                console.log('react', name)
            })
        }
    }
    
    
    let l = new Lesson()
    
    l.tap();  //æ³¨å†Œä¸¤ä¸ªå‡½æ•°
    l.start() // å¯åŠ¨å‹¾å­
    
    

1.theory.js

    class SyncHook {  // å‹¾å­æ˜¯åŒæ­¥çš„
        constructor(args) {  // args => ['name']
            this.tasks = []
        }
        tap (name, task) {
            this.tasks.push(task)
        }
        call (...args) {
            this.tasks.forEach((task) => task(...args))
        }
    }
    
    let hook = new SyncHook(['name'])
    
    hook.tap('react', function (name) {
        console.log('react', name);
    })
    
    
    hook.tap('node', function (name) {
        console.log('node', name);
    })
    
    
    hook.call('jw')
    

tapableä»‹ç» - SyncBailHook

SyncBailHookä¸ºå‹¾å­åŠ äº†ä¸ªä¿é™©ï¼Œå½“returnè¿”å›ä¸æ˜¯undefineå°±ä¼šåœæ­¢

2.use.js

    let {SyncBailHook} = require('tapable')   // è§£æ„åŒæ­¥å‹¾å­
    
    
    class Lesson {
        constructor () {
            this.hooks = {
                // è®¢é˜…å‹¾å­
                arch: new SyncBailHook(['name']),
    
            }
        }
        start () {
            // å‘å¸ƒ
            this.hooks.arch.call('may')
        }
        tap () {   //  æ³¨å†Œç›‘å¬å‡½æ•°,è®¢é˜…
            this.hooks.arch.tap('node', function (name) {
                console.log('node', name)
                return 'åœæ­¢å­¦ä¹ '  // ä¼šåœæ­¢
                // return undefined
            })
            this.hooks.arch.tap('react', function (name) {
                console.log('react', name)
            })
        }
    }
    
    
    let l = new Lesson()
    
    l.tap();  //æ³¨å†Œä¸¤ä¸ªå‡½æ•°
    l.start() // å¯åŠ¨å‹¾å­
    
    

2.theory.js

    class SyncBailHook {  // å‹¾å­æ˜¯åŒæ­¥çš„
        constructor(args) {  // args => ['name']
            this.tasks = []
        }
        tap (name, task) {
            this.tasks.push(task)
        }
        call (...args) {
            let ret;   // å½“å‰å‡½æ•°çš„è¿”å›å€¼
            let index = 0; // å½“å‰è¦æ‰§è¡Œçš„ç¬¬ä¸€ä¸ª
            do {
                ret = this.tasks[index](...args)
            } while (ret === undefined  && index < this.tasks.length)
        }
    }
    
    let hook = new SyncBailHook(['name'])
    
    hook.tap('react', function (name) {
        console.log('react', name);
        return 'åœæ­¢å­¦ä¹ '
        // return undefined
    })
    
    
    hook.tap('node', function (name) {
        console.log('node', name);
    })
    
    
    hook.call('jw')
    
    

tapableä»‹ç» - SyncWaterfallHook

SyncWaterfallHookä¸Šä¸€ä¸ªç›‘å¬å‡½æ•°çš„è¿”å›å€¼å¯ä»¥ä¼ ç»™ä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°

3.use.js

    let {SyncWaterfallHook} = require('tapable')   // è§£æ„åŒæ­¥å‹¾å­
    
    // waterfall ç€‘å¸ƒ
    
    class Lesson {
        constructor () {
            this.hooks = {
                // è®¢é˜…å‹¾å­
                arch: new SyncWaterfallHook(['name']),
    
            }
        }
        start () {
            // å‘å¸ƒ
            this.hooks.arch.call('may')
        }
        tap () {   //  æ³¨å†Œç›‘å¬å‡½æ•°,è®¢é˜…
            this.hooks.arch.tap('node', function (name) {
                console.log('node', name)
                return 'å­¦çš„ä¸é”™'
            })
            this.hooks.arch.tap('react', function (name) {
                console.log('react', name)
            })
        }
    }
    
    
    let l = new Lesson()
    
    l.tap();  //æ³¨å†Œä¸¤ä¸ªå‡½æ•°
    l.start() // å¯åŠ¨å‹¾å­
    
    

3.theory.js

    class SyncWaterfallHook {  // å‹¾å­æ˜¯åŒæ­¥çš„ - ç€‘å¸ƒ
        constructor(args) {  // args => ['name']
            this.tasks = []
        }
        tap (name, task) {
            this.tasks.push(task)
        }
        call (...args) {
            let [first, ...others] = this.tasks;
            let ret = first(...args)
            others.reduce((a, b) => {
                return b(a);
            }, ret);
    
        }
    }
    
    let hook = new SyncWaterfallHook(['name'])
    
    hook.tap('react', function (name) {
        console.log('react', name);
        return 'react Ok'
        // return undefined
    })
    
    
    hook.tap('node', function (name) {
        console.log('node', name);
        return 'node Ok'
    })
    
    hook.tap('webpack', function (data) {
        console.log('webpack', data);
    })
    
    
    
    hook.call('jw')
    
    
    

tapableä»‹ç» - SyncLoopHook

SyncLoopHookå½“ç›‘å¬å‡½æ•°è¢«è§¦å‘çš„æ—¶å€™ï¼Œå¦‚æœè¯¥ç›‘å¬å‡½æ•°è¿”å›trueæ—¶åˆ™è¿™ä¸ªç›‘å¬å‡½æ•°ä¼šåå¤æ‰§è¡Œï¼Œå¦‚æœè¿”å› undefined åˆ™è¡¨ç¤ºé€€å‡ºå¾ªç¯

4.use.js

    let {SyncLoopHook} = require('tapable')   // è§£æ„åŒæ­¥å‹¾å­
    
    // ä¸è¿”å›undefined ä¼šå¤šæ¬¡æ‰§è¡Œ
    
    class Lesson {
        constructor () {
            this.index = 0
            this.hooks = {
                // è®¢é˜…å‹¾å­
                arch: new SyncLoopHook(['name']),
    
            }
        }
        start () {
            // å‘å¸ƒ
            this.hooks.arch.call('may')
        }
        tap () {   //  æ³¨å†Œç›‘å¬å‡½æ•°,è®¢é˜…
            this.hooks.arch.tap('node',  (name) => {
                console.log('node', name)
                return ++this.index === 3 ? undefined : 'ç»§ç»­å­¦'
            })
            this.hooks.arch.tap('react',  (name) => {
                console.log('react', name)
            })
        }
    }
    
    
    let l = new Lesson()
    
    l.tap();  //æ³¨å†Œä¸¤ä¸ªå‡½æ•°
    l.start() // å¯åŠ¨å‹¾å­
    
    

4.theory.js

    class SyncLoopHook {  // å‹¾å­æ˜¯åŒæ­¥çš„ - ç€‘å¸ƒ
        constructor(args) {  // args => ['name']
            this.tasks = []
        }
        tap (name, task) {
            this.tasks.push(task)
        }
        call (...args) {
            this.tasks.forEach(task => {
                let ret
                do {
                    ret = task(...args);
                } while(ret !== undefined)
            })
        }
    }
    
    let hook = new SyncLoopHook(['name'])
    let total = 0
    hook.tap('react', function (name) {
        console.log('react', name);
        return ++total === 3 ? undefined: 'ç»§ç»­å­¦'
    })
    
    
    hook.tap('node', function (name) {
        console.log('node', name);
    })
    
    hook.tap('webpack', function (data) {
        console.log('webpack', data);
    })
    
    
    
    hook.call('jw')
    
    

AsyncParallelHook ä¸ AsyncParallelBailHook

å¼‚æ­¥çš„å‹¾å­åˆ†ä¸¤ç§ä¸²è¡Œå’Œå¹¶è¡Œ

å¹¶è¡Œç­‰å¾…æ‰€æœ‰å¹¶å‘çš„å¼‚æ­¥äº‹ä»¶æ‰§è¡Œåæ‰§è¡Œå›è°ƒ

æ³¨å†Œçš„ä¸‰ç§æ–¹æ³•

1. å¼‚æ­¥çš„æ³¨å†Œæ–¹æ³•tap
2. å¼‚æ­¥çš„æ³¨å†Œæ–¹æ³•tapAsyncï¼Œ è¿˜æœ‰ä¸ªå›è°ƒå‚æ•°
3. topPromise,æ³¨å†Œpromise

è°ƒç”¨çš„ä¸‰ç§

1. call (åŒæ­¥)
2. callAsync ï¼ˆå¼‚æ­¥ï¼‰
3. promise ï¼ˆå¼‚æ­¥ï¼‰

è¿™é‡Œä»‹ç»çš„æ˜¯å¼‚æ­¥å¹¶è¡Œçš„

AsyncParallelHook

ä¸å…³å¿ƒç›‘å¬å‡½æ•°çš„è¿”å›å€¼ã€‚

5.use.js

    let {AsyncParallelHook} = require('tapable')   // è§£æ„åŒæ­¥å‹¾å­
    
    // ä¸è¿”å›undefined ä¼šå¤šæ¬¡æ‰§è¡Œ
    
    class Lesson {
        constructor() {
            this.index = 0
            this.hooks = {
                // è®¢é˜…å‹¾å­
                arch: new AsyncParallelHook(['name']),
    
            }
        }
    
        start() {
            // å‘å¸ƒcallAsync
            // this.hooks.arch.callAsync('may', function () {
            //     console.log('end');
            // })
            // å¦ä¸€ç§å‘å¸ƒpromise
            this.hooks.arch.promise('may').then(function () {
                    console.log('end');
                }
            )
        }
    
        tap() {   //  æ³¨å†Œç›‘å¬å‡½æ•°,è®¢é˜…
            // æ³¨å†ŒtapAsync
            // this.hooks.arch.tapAsync('node',  (name, callback) => {
            //     setTimeout(() => {
            //         console.log('node', name)
            //         callback()
            //     }, 1000)
            // })
            // this.hooks.arch.tapAsync('react',  (name, callback) => {
            //     setTimeout(() => {
            //         console.log('react', name)
            //         callback()
            //     }, 1000)
            // })
            // å¦ä¸€ç§è®¢é˜… tapPromise
            this.hooks.arch.tapPromise('node', (name) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log('node', name)
                        resolve()
                    }, 1000)
                })
            })
            this.hooks.arch.tapPromise('react', (name) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log('react', name)
                        resolve()
                    }, 1000)
                })
            })
        }
    }
    
    
    let l = new Lesson()
    
    l.tap();  //æ³¨å†Œä¸¤ä¸ªå‡½æ•°
    l.start() // å¯åŠ¨å‹¾å­
    
    
    

5.theory.js

    class AsyncParallelHook {  // å‹¾å­æ˜¯åŒæ­¥çš„ - ç€‘å¸ƒ
        constructor(args) {  // args => ['name']
            this.tasks = []
        }
    
        tapAsync(name, task) {
            this.tasks.push(task)
        }
    
        tapPromise(name, task) {
            this.tasks.push(task)
        }
        callAsync(...args) {
            let finalCallback = args.pop()   // æ‹¿å‡ºæœ€ç»ˆçš„å‡½æ•°
            let index = 0
            let done = () => {   // ç±»ä¼¼promise.allçš„å®ç°
                index++;
                if (index === this.tasks.length) {
                    finalCallback();
                }
            }
            this.tasks.forEach(task => {
                task(...args, done) // è¿™é‡Œçš„args å·²ç»æŠŠæœ€åä¸€ä¸ªå‚æ•°åˆ æ‰
            })
        }
    
        promise(...args) {
            let tasks = this.tasks.map(task => task(...args))
            return Promise.all(tasks)
        }
    }
    
    let hook = new AsyncParallelHook(['name'])
    
    
    // hook.tapAsync('react', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('react', name);
    //         callback()
    //     }, 1000)
    // })
    //
    // hook.tapAsync('node', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('node', name);
    //         callback()
    //     }, 1000)
    // })
    
    // hook.tapAsync('webpack', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('webpack', name);
    //         callback()
    //     }, 1000)
    // })
    
    hook.tapPromise('react', function (name, callback) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                console.log('react', name);
                resolve()
            }, 1000)
        })
    })
    
    hook.tapPromise('node', function (name, callback) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                console.log('node', name);
                resolve()
            }, 1000)
        })
    })
    
    
    
    //
    // hook.callAsync('jw', function () {
    //     console.log('end');
    // })
    
    
    hook.promise('jw').then(function () {
        console.log('end');
    })
    
    
    

AsyncParallelBailHook

åªè¦ç›‘å¬å‡½æ•°çš„è¿”å›å€¼ä¸ä¸º nullï¼Œå°±ä¼šå¿½ç•¥åé¢çš„ç›‘å¬å‡½æ•°æ‰§è¡Œï¼Œç›´æ¥è·³è·ƒåˆ°callAsyncç­‰è§¦å‘å‡½æ•°ç»‘å®šçš„å›è°ƒå‡½æ•°ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªè¢«ç»‘å®šçš„å›è°ƒå‡½æ•°ã€‚

ä½¿ç”¨å’ŒåŸç†ä¸SyncBailHookç›¸ä¼¼

å¼‚æ­¥ä¸²è¡Œ â€”â€” AsyncSeriesHook

ä¸²è¡Œone by one

6.use.js

    let {AsyncSeriesHook} = require('tapable')   // è§£æ„åŒæ­¥å‹¾å­
    
    
    class Lesson {
        constructor() {
            this.index = 0
            this.hooks = {
                // è®¢é˜…å‹¾å­
                arch: new AsyncSeriesHook(['name']),
    
            }
        }
    
        start() {
            // å‘å¸ƒ
            // this.hooks.arch.callAsync('may', function () {
            //     console.log('end');
            // })
            // å¦ä¸€ç§å‘å¸ƒ
            this.hooks.arch.promise('may').then(function () {
                    console.log('end');
                }
            )
        }
    
        tap() {   //  æ³¨å†Œç›‘å¬å‡½æ•°,è®¢é˜…
            // this.hooks.arch.tapAsync('node',  (name, callback) => {
            //     setTimeout(() => {
            //         console.log('node', name)
            //         callback()
            //     }, 1000)
            // })
            // this.hooks.arch.tapAsync('react',  (name, callback) => {
            //     setTimeout(() => {
            //         console.log('react', name)
            //         callback()
            //     }, 1000)
            // })
            // å¦ä¸€ç§è®¢é˜…
            this.hooks.arch.tapPromise('node', (name) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log('node', name)
                        resolve()
                    }, 1000)
                })
            })
            this.hooks.arch.tapPromise('react', (name) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log('react', name)
                        resolve()
                    }, 1000)
                })
            })
        }
    }
    
    
    let l = new Lesson()
    
    l.tap();  //æ³¨å†Œä¸¤ä¸ªå‡½æ•°
    l.start(); // å¯åŠ¨å‹¾å­
    
    

6.theory.js

    class AsyncSeriesHook {  //
        constructor(args) {  // args => ['name']
            this.tasks = []
        }
    
        tapAsync(name, task) {
            this.tasks.push(task)
        }
    
        tapPromise(name, task) {
            this.tasks.push(task)
        }
    
        callAsync(...args) {
            let finalCallback = args.pop()
            let index = 0;
            let next = () => {
                if (this.tasks.length === index) return finalCallback();
                let task = this.tasks[index++];
                task(...args, next);
            }
            next();
        }
    
        promise(...args) {
            // å°†promiseä¸²è”èµ·æ¥
            let [first, ...other] = this.tasks
            return other.reduce((p, n) => {
                 return p.then(() => n (...args))
            }, first(...args))
        }
    }
    
    let hook = new AsyncSeriesHook(['name'])
    
    
    // hook.tapAsync('react', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('react', name);
    //         callback()
    //     }, 1000)
    // })
    //
    // hook.tapAsync('node', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('node', name);
    //         callback()
    //     }, 1000)
    // })
    //
    // hook.tapAsync('webpack', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('webpack', name);
    //         callback()
    //     }, 1000)
    // })
    
    
    hook.tapPromise('react', function (name, callback) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                console.log('react', name);
                resolve()
            }, 1000)
        })
    })
    
    hook.tapPromise('node', function (name, callback) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                console.log('node', name);
                resolve()
            }, 1000)
        })
    })
    
    
    
    
    // hook.callAsync('jw', function () {
    //     console.log('end');
    // })
    
    
    hook.promise('jw').then(function () {
        console.log('end');
    })
    
    

å¼‚æ­¥ä¸²è¡Œ â€”â€” AsyncSeriesWaterfallHook

ä¸Šä¸€ä¸ªç›‘å¬å‡½æ•°çš„ä¸­çš„callback(err, data)çš„ç¬¬äºŒä¸ªå‚æ•°,å¯ä»¥ä½œä¸ºä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°çš„å‚æ•°

7.use.js

    let {AsyncSeriesWaterfallHook} = require('tapable')   // è§£æ„åŒæ­¥å‹¾å­
    
    
    class Lesson {
        constructor() {
            this.index = 0
            this.hooks = {
                // è®¢é˜…å‹¾å­
                arch: new AsyncSeriesWaterfallHook(['name']),
    
            }
        }
    
        start() {
            // å‘å¸ƒ
            this.hooks.arch.callAsync('may', function () {
                console.log('end');
            })
            // å¦ä¸€ç§å‘å¸ƒ
            // this.hooks.arch.promise('may').then(function () {
            //         console.log('end');
            //     }
            // )
        }
    
        tap() {   //  æ³¨å†Œç›‘å¬å‡½æ•°,è®¢é˜…
            this.hooks.arch.tapAsync('node',  (name, callback) => {
                setTimeout(() => {
                    console.log('node', name)
                    // callback(null, 'result')
                    callback('error', 'result')   // å¦‚æœæ”¾error, ä¼šè·³è¿‡ç›´æ¥åé¢çš„å‹¾å­ï¼Œç›´æ¥èµ°åˆ°æœ€ç»ˆçš„
    
                }, 1000)
            })
            this.hooks.arch.tapAsync('react',  (name, callback) => {
                setTimeout(() => {
                    console.log('react', name)
                    callback()
                }, 1000)
            })
            // å¦ä¸€ç§è®¢é˜…
            // this.hooks.arch.tapPromise('node', (name) => {
            //     return new Promise((resolve, reject) => {
            //         setTimeout(() => {
            //             console.log('node', name)
            //             resolve()
            //         }, 1000)
            //     })
            // })
            // this.hooks.arch.tapPromise('react', (name) => {
            //     return new Promise((resolve, reject) => {
            //         setTimeout(() => {
            //             console.log('react', name)
            //             resolve()
            //         }, 1000)
            //     })
            // })
        }
    }
    
    
    let l = new Lesson()
    
    l.tap();  //æ³¨å†Œä¸¤ä¸ªå‡½æ•°
    l.start(); // å¯åŠ¨å‹¾å­
    
    

7.theory.js

    class AsyncSeriesWaterfallHook {  //
        constructor(args) {  // args => ['name']
            this.tasks = []
        }
    
        tapAsync(name, task) {
            this.tasks.push(task)
        }
    
        tapPromise(name, task) {
            this.tasks.push(task)
        }
        callAsync(...args) {
            let finalCallback = args.pop()
            let index = 0;
            let next = (err, data) => {
                let task = this.tasks[index]
                if(!task) return finalCallback();
                if (index === 0) {
                    // æ‰§è¡Œçš„ç¬¬ä¸€ä¸ª
                    task(...args, next)
                } else {
                    task(data, next)
                }
                index ++
            }
            next();
        }
    
        promise(...args) {
            // å°†promiseä¸²è”èµ·æ¥
            let [first, ...other] = this.tasks
            return other.reduce((p, n) => {
                 return p.then((data) => n(data))
            }, first(...args))
        }
    }
    
    let hook = new AsyncSeriesWaterfallHook(['name'])
    
    
    // hook.tapAsync('react', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('react', name);
    //         callback(null, 'ç»“æœ1')
    //     }, 1000)
    // })
    //
    // hook.tapAsync('node', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('node', name);
    //         callback(null, 'ç»“æœ2')
    //     }, 1000)
    // })
    //
    // hook.tapAsync('webpack', function (name, callback) {
    //     setTimeout(() => {
    //         console.log('webpack', name);
    //         callback()
    //     }, 1000)
    // })
    
    //
    hook.tapPromise('react', function (name, callback) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                console.log('react', name);
                resolve('result')
            }, 1000)
        })
    })
    
    hook.tapPromise('node', function (name, callback) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                console.log('node', name);
                resolve()
            }, 1000)
        })
    })
    
    
    //
    //
    // hook.callAsync('jw', function () {
    //     console.log('end');
    // })
    
    
    hook.promise('jw').then(function () {
        console.log('end');
    })
    
    

æ‰‹å†™webpack

å¯¹åº”çš„may-packé¡¹ç›®

yarn add webpack webpack-cli -D

webpack.config.js

    let path = require('path')
    
    module.exports = {
        mode: 'development',
        entry: './src/index.js',
        output: {
            filename: 'bundle.js',
            path: path.resolve(__dirname, 'dist')
        }
    }
    

npx webpack

ç”Ÿæˆæ–‡ä»¶bundle.js

    (function (modules) {
        var installedModules = {};
    
        function __webpack_require__(moduleId) {
    
            if (installedModules[moduleId]) {
                return installedModules[moduleId].exports;
            }
            var module = installedModules[moduleId] = {
                i: moduleId,
                l: false,
                exports: {}
            };
    
            modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
    
            module.l = true;
    
            return module.exports;
        }
    
    
        // Load entry module and return exports
        return __webpack_require__(__webpack_require__.s = "./src/index.js");
    })
    ({
        "./src/a.js":
            (function (module, exports, __webpack_require__) {
                eval("let b = __webpack_require__(/*! ./base/b */ \"./src/base/b.js\")\n\nmodule.exports = 'a'+ b\n\n\n\n//# sourceURL=webpack:///./src/a.js?");
            }),
        "./src/base/b.js":
            (function (module, exports) {
                eval("module.exports = 'b'\n\n\n//# sourceURL=webpack:///./src/base/b.js?");
            }),
        "./src/index.js":
            (function (module, exports, __webpack_require__) {
                eval(" let str = __webpack_require__(/*! ./a.js */ \"./src/a.js\")\n\n console.log(str);\n\n\n//# sourceURL=webpack:///./src/index.js?");
            })
    
    });
    
    

æ–°å»ºé¡¹ç›®ç”¨äºè‡ªå·±çš„webpack,è¿™é‡Œå«may-pack

yarn init

å¦‚æœåœ¨nodeé‡Œæƒ³æ‰§è¡Œå‘½ä»¤ï¼Œåˆ›å»ºbinæ–‡ä»¶,å†åˆ›å»ºmay-pack.js

é…ç½®package.json

    {
      "name": "may-pack",
      "version": "1.0.0",
      "main": "index.js",
      "license": "MIT",
      "bin": {
        "may-pack": "./bin/may-pack.js"
      }
    }
    

may-pack.js

    #!  /usr/bin/env node 
    
    // nodeç¯å¢ƒ
    
    console.log('start');
    
    

è¿è¡Œnpm linkå°†npm æ¨¡å—é“¾æ¥åˆ°å¯¹åº”çš„è¿è¡Œé¡¹ç›®ä¸­å»ï¼Œæ–¹ä¾¿åœ°å¯¹æ¨¡å—è¿›è¡Œè°ƒè¯•å’Œæµ‹è¯•

åœ¨æƒ³è¿è¡Œmay-packçš„é¡¹ç›®ä¸­è¿è¡Œï¼Œnpm link may-pack å¾—åˆ° start

webpackåˆ†æåŠå¤„ç†

may-pack.js

    #!  /usr/bin/env node
    
    // nodeç¯å¢ƒ
    
    console.log('start');
    
    let path = require('path')
    
    // æ‹¿åˆ°é…ç½®æ–‡ä»¶webpack.config.js
    let config = require(path.resolve('webpack.config.js'));
    
    
    let Compiler = require('../lib/Compiler.js');
    
    let compiler = new Compiler(config);
    
    // æ ‡è¯†è¿è¡Œç¼–è¯‘
    compiler.run()
    
    

åˆ›å»ºlibæ–‡ä»¶Compiler.js

    let path = require('path')
    let fs = require('fs')
    
    class Compiler {
        constructor(config) {
            // entry  output
            this.config = config
            // éœ€è¦ä¿å­˜å…¥å£æ–‡ä»¶çš„è·¯å¾„
            this.entryId = '';   // './src/index.js'
            // éœ€è¦ä¿å­˜æ‰€æœ‰çš„æ¨¡å—ä¾èµ–
            this.modules = {};
            this.entry = config.entry  // å…¥å£æ–‡ä»¶
            // å·¥ä½œç›®å½•
            this.root = process.cwd(); // å½“å‰è¿è¡Œnpxçš„è·¯å¾„
        }
        
        // æ„å»ºæ¨¡å—
        buildModule(modulePath, isEntry) {
           
        }
    
        // å‘å°„æ–‡ä»¶
        emitFile() {
            // ç”¨æ•°æ® æ¸²æŸ“æƒ³è¦çš„
        }
    
        run() {
            // æ‰§è¡Œ åˆ›å»ºæ¨¡å—çš„ä¾èµ–å…³ç³»
            this.buildModule(path.resolve(this.root, this.entry), true)  // path.resolve(this.root, this.entry) å¾—åˆ°å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
            // å‘å°„æ‰“åŒ…åçš„æ–‡ä»¶
            this.emitFile()
        }
    }
    
    module.exports = Compiler
    
    

ä¸»è¦ä¸¤ä¸ªä»»åŠ¡

1. æ‹¿åˆ°å…¥å£Id
2. è§£ææ¨¡å—ï¼Œä¹Ÿå°±æ˜¯å®ç°buildModuleæ–¹æ³•

åˆ›å»ºä¾èµ–å…³ç³»

may-packä¸­Compiler.js

    let path = require('path')
    let fs = require('fs')
    // babylon  ä¸»è¦æŠŠæºç è½¬æˆast Babylon æ˜¯ Babel ä¸­ä½¿ç”¨çš„ JavaScript è§£æå™¨ã€‚
    // @babel/traverse å¯¹astè§£æéå†è¯­æ³•æ ‘ è´Ÿè´£æ›¿æ¢ï¼Œåˆ é™¤å’Œæ·»åŠ èŠ‚ç‚¹
    // @babel/types ç”¨äºASTèŠ‚ç‚¹çš„Lodash-esqueå®ç”¨ç¨‹åºåº“
    // @babel/generator ç»“æœç”Ÿæˆ
    
    let babylon = require('babylon')
    let traverse = require('@babel/traverse').default;
    let type = require('@babel/types');
    let generator = require('@babel/generator').default
    class Compiler {
        constructor(config) {
            // entry  output
            this.config = config
            // éœ€è¦ä¿å­˜å…¥å£æ–‡ä»¶çš„è·¯å¾„
            this.entryId = '';   // './src/index.js'
            // éœ€è¦ä¿å­˜æ‰€æœ‰çš„æ¨¡å—ä¾èµ–
            this.modules = {};
            this.entry = config.entry  // å…¥å£æ–‡ä»¶
            // å·¥ä½œç›®å½•
            this.root = process.cwd(); // å½“å‰è¿è¡Œnpxçš„è·¯å¾„
    
    
        }
        // æ‹¿åˆ°æ¨¡å—å†…å®¹
        getSource (modulePath) {
            let content = fs.readFileSync(modulePath, 'utf8')
            return content
        }
        parse (source, parentPath) {
            console.log(source, parentPath)
        }
        // æ„å»ºæ¨¡å—
        buildModule(modulePath, isEntry) {
            // æ‹¿åˆ°æ¨¡å—å†…å®¹
            let source = this.getSource(modulePath)  // å¾—åˆ°å…¥å£æ–‡ä»¶çš„å†…å®¹
            // æ¨¡å—id modulePath(éœ€è¦ç›¸å¯¹è·¯å¾„) = modulePath(æ¨¡å—è·¯å¾„) - this.root(é¡¹ç›®å·¥ä½œè·¯å¾„)   src/index.js
            let moduleName = './' + path.relative(this.root, modulePath)
            console.log(source, moduleName);  // æ‹¿åˆ°ä»£ç  å’Œç›¸å¯¹è·¯å¾„ ./src/index.js
            if (isEntry) {
                this.entryId = moduleName
            }
            let {sourceCode, dependencies} = this.parse(source, path.dirname(moduleName))   // ./src
            // æŠŠç›¸å¯¹è·¯å¾„å’Œæ¨¡å—ä¸­çš„å†…å®¹å¯¹åº”èµ·æ¥
            this.modules[moduleName] = sourceCode
        }
    
        // å‘å°„æ–‡ä»¶
        emitFile() {
            // ç”¨æ•°æ® æ¸²æŸ“æƒ³è¦çš„
        }
    
        run() {
            // æ‰§è¡Œ åˆ›å»ºæ¨¡å—çš„ä¾èµ–å…³ç³»
            this.buildModule(path.resolve(this.root, this.entry), true)  // path.resolve(this.root, this.entry) å¾—åˆ°å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
            console.log(this.modules, this.entryId);
            // å‘å°„æ‰“åŒ…åçš„æ–‡ä»¶
            this.emitFile()
        }
    
    
    }
    
    module.exports = Compiler
    
    
    

asté€’å½’è§£æ

parseæ–¹æ³•ä¸»è¦é è§£æè¯­æ³•æ ‘æ¥è¿›è¡Œè½¬ä¹‰

babylon  ä¸»è¦æŠŠæºç è½¬æˆast Babylon æ˜¯ Babel ä¸­ä½¿ç”¨çš„ JavaScript è§£æå™¨ã€‚

@babel/traverse å¯¹astè§£æéå†è¯­æ³•æ ‘ è´Ÿè´£æ›¿æ¢ï¼Œåˆ é™¤å’Œæ·»åŠ èŠ‚ç‚¹

@babel/types ç”¨äºASTèŠ‚ç‚¹çš„Lodash-esqueå®ç”¨ç¨‹åºåº“

@babel/generator ç»“æœç”Ÿæˆ

yarn add babylon @babel/traverse @babel/types @babel/generator

may-packä¸­Compiler.js

    let path = require('path')
    let fs = require('fs')
    // babylon  ä¸»è¦æŠŠæºç è½¬æˆast Babylon æ˜¯ Babel ä¸­ä½¿ç”¨çš„ JavaScript è§£æå™¨ã€‚
    // @babel/traverse å¯¹astè§£æéå†è¯­æ³•æ ‘ è´Ÿè´£æ›¿æ¢ï¼Œåˆ é™¤å’Œæ·»åŠ èŠ‚ç‚¹
    // @babel/types ç”¨äºASTèŠ‚ç‚¹çš„Lodash-esqueå®ç”¨ç¨‹åºåº“
    // @babel/generator ç»“æœç”Ÿæˆ
    
    let babylon = require('babylon')
    let traverse = require('@babel/traverse').default;
    let type = require('@babel/types');
    let generator = require('@babel/generator').default
    class Compiler {
        constructor(config) {
            // entry  output
            this.config = config
            // éœ€è¦ä¿å­˜å…¥å£æ–‡ä»¶çš„è·¯å¾„
            this.entryId = '';   // './src/index.js'
            // éœ€è¦ä¿å­˜æ‰€æœ‰çš„æ¨¡å—ä¾èµ–
            this.modules = {};
            this.entry = config.entry  // å…¥å£æ–‡ä»¶
            // å·¥ä½œç›®å½•
            this.root = process.cwd(); // å½“å‰è¿è¡Œnpxçš„è·¯å¾„
    
    
        }
        // æ‹¿åˆ°æ¨¡å—å†…å®¹
        getSource (modulePath) {
            let content = fs.readFileSync(modulePath, 'utf8')
            return content
        }
        parse (source, parentPath) {
            // ASTè§£æè¯­æ³•æ ‘
            let ast = babylon.parse(source)
            let dependencies = []; // ä¾èµ–çš„æ•°ç»„
            // https://astexplorer.net/
            traverse(ast, {
                // è°ƒç”¨è¡¨è¾¾å¼
                CallExpression(p) {
                    let node = p.node; //å¯¹åº”çš„èŠ‚ç‚¹
                    if(node.callee.name === 'require') {
                       node.callee.name = '__webpack_require__'
                        let moduledName = node.arguments[0].value   // å–åˆ°æ¨¡å—çš„å¼•ç”¨åå­—
                        moduledName = moduledName + (path.extname(moduledName) ? '': '.js');  // ./a.js
                        moduledName = './' + path.join(parentPath, moduledName)  // './src/a.js'
                        dependencies.push(moduledName)
                        node.arguments = [type.stringLiteral(moduledName)] // æ”¹æ‰æºç 
                    }
                }
            })
            let sourceCode = generator(ast).code
            return { sourceCode, dependencies }
        }
        // æ„å»ºæ¨¡å—
        buildModule(modulePath, isEntry) {
            // æ‹¿åˆ°æ¨¡å—å†…å®¹
            let source = this.getSource(modulePath)  // å¾—åˆ°å…¥å£æ–‡ä»¶çš„å†…å®¹
            // æ¨¡å—id modulePath(éœ€è¦ç›¸å¯¹è·¯å¾„) = modulePath(æ¨¡å—è·¯å¾„) - this.root(é¡¹ç›®å·¥ä½œè·¯å¾„)   src/index.js
            let moduleName = './' + path.relative(this.root, modulePath)
            // console.log(source, moduleName);  // æ‹¿åˆ°ä»£ç  å’Œç›¸å¯¹è·¯å¾„ ./src/index.js
            if (isEntry) {
                this.entryId = moduleName
            }
            // è§£ææŠŠsourceæºç è¿›è¡Œæ”¹é€ ï¼Œ è¿”å›ä¸€ä¸ªä¾èµ–åˆ—è¡¨
            let {sourceCode, dependencies} = this.parse(source, path.dirname(moduleName))   // ./src
            // æŠŠç›¸å¯¹è·¯å¾„å’Œæ¨¡å—ä¸­çš„å†…å®¹å¯¹åº”èµ·æ¥
            this.modules[moduleName] = sourceCode
            dependencies.forEach(dep => {  // é™„æ¨¡å—çš„åŠ è½½ é€’å½’åŠ è½½
                this.buildModule(path.join(this.root, dep), false)
            })
        }
    
        // å‘å°„æ–‡ä»¶
        emitFile() {
            // ç”¨æ•°æ® æ¸²æŸ“æƒ³è¦çš„
        }
    
        run() {
            // æ‰§è¡Œ åˆ›å»ºæ¨¡å—çš„ä¾èµ–å…³ç³»
            this.buildModule(path.resolve(this.root, this.entry), true)  // path.resolve(this.root, this.entry) å¾—åˆ°å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
            console.log(this.modules, this.entryId);
            // å‘å°„æ‰“åŒ…åçš„æ–‡ä»¶
            this.emitFile()
        }
    
    
    }
    
    module.exports = Compiler
    
    

ç”Ÿæˆæ‰“åŒ…å·¥å…·

ä½¿ç”¨ejsæ¨¡æ¿

may-packä¸­main.ejs

    (function (modules) {
    var installedModules = {};
    
    function __webpack_require__(moduleId) {
    
    if (installedModules[moduleId]) {
    return installedModules[moduleId].exports;
    }
    var module = installedModules[moduleId] = {
    i: moduleId,
    l: false,
    exports: {}
    };
    
    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
    
    module.l = true;
    
    return module.exports;
    }
    
    
    // Load entry module and return exports
    return __webpack_require__(__webpack_require__.s = "<%-entryId %>");
    })({
    <% for(let key in modules){ %>
        "<%- key %>":
        (function (module, exports,__webpack_require__) {
    eval(`<%-modules[key] %>`);
    }),
    <% } %>
    });
    
    

ejså…¥é—¨

yarn add ejs

may-packä¸­Compiler.js

    let ejs = require('ejs')
    

    // å‘å°„æ–‡ä»¶
        emitFile() {
            // ç”¨æ•°æ® æ¸²æŸ“æƒ³è¦çš„
            // è¾“å‡ºåˆ°é‚£ä¸ªç›®å½•ä¸‹
            let main = path.join(this.config.output.path, this.config.output.filename)
            let templateStr = this.getSource(path.join(__dirname, 'main.ejs'))
            let code = ejs.render(templateStr, { entryId: this.entryId, modules: this.modules})
            this.assets = {}
            // è·¯å¾„å¯¹åº”çš„ä»£ç 
            this.assets[main] = code
            fs.writeFileSync(main, this.assets[main])
        }
    

åœ¨webpack-trainingé¡¹ç›®ä¸­è¿è¡Œnpx may-pack, å¾—åˆ°bundle.js,è¿è¡Œå¾—åˆ°ç»“æœ

å¢åŠ loader

åˆ›å»ºloaderæ–‡ä»¶å¤¹ï¼Œåˆ›å»ºless-loader1.jså’Œstyle-loader1.js

yarn add less

lessä½¿ç”¨

less-loader1.js

    // å°†lessè½¬ä¸ºcss
    let less = require('less')
    
    function loader(source) {
        let css = ''
        less.render(source, function (err, output) {
            css = output.css
        })
        css = css.replace(/\n/g, '\\n');
        return css
    }
    
    module.exports = loader
    
    

style-loader1.js

    // å°†cssæ’å…¥åˆ°htmlå¤´éƒ¨
    function loader(source) {
        console.log(111);
        let style = `
        let style = document.createElement('style')
        style.innerHTML = ${JSON.stringify(source)}
        document.head.appendChild(style)
       `
        return style
    }
    module.exports = loader
    
    
    // JSON.stringify(source) å¯ä»¥å°†ä»£ç è½¬ä¸ºä¸€è¡Œ
    
    

webpack.config.js

    let path = require('path')
    
    module.exports = {
        mode: 'development',
        entry: './src/index.js',
        output: {
            filename: 'bundle.js',
            path: path.resolve(__dirname, 'dist')
        },
        module: {
            rules: [
                {
                    test: /\.less$/,
                    use: [
                        path.resolve(__dirname, 'loader', 'style-loader1'),
                        path.resolve(__dirname, 'loader', 'less-loader1')
                    ]
                }
            ]
        }
    }
    
    

åˆ›å»ºindex.less

    body {
      background: red
    }
    

index.js

     let str = require('./a.js')
    
     require('./index.less')
    
     console.log(str);
    
    

may-packä¸­Compiler.js

    // æ‹¿åˆ°æ¨¡å—å†…å®¹
        getSource (modulePath) {
            // åŒ¹é…å„ç§æ–‡ä»¶çš„è§„åˆ™
            let rules= this.config.module.rules;   // webpack.config.js ä¸­rulesçš„æ•°ç»„
            let content = fs.readFileSync(modulePath, 'utf8')
    
            for (let i = 0; i < rules.length; i++) {
                let rule = rules[i]
                let {test, use} = rule
                let len = use.length - 1
    
                if (test.test(modulePath)) {
                    // console.log(use[len]);
                    function normalLoader () {
                        // console.log(use[len--]);
                        let loader = require(use[len--])
                        content = loader(content)
                        // é€’å½’è°ƒç”¨loader å®ç°è½¬åŒ–
                        if (len >= 0) {
                            normalLoader()
                        }
                    }
                    normalLoader()
                }
    
            }
            return content
        }
    

è¿è¡Œnpx may-pack

å¢åŠ plugins

yarn add tapable

may-packä¸­Compiler.js

    constructor(config) {
            // entry  output
            this.config = config
            // éœ€è¦ä¿å­˜å…¥å£æ–‡ä»¶çš„è·¯å¾„
            this.entryId = '';   // './src/index.js'
            // éœ€è¦ä¿å­˜æ‰€æœ‰çš„æ¨¡å—ä¾èµ–
            this.modules = {};
            this.entry = config.entry  // å…¥å£æ–‡ä»¶
            // å·¥ä½œç›®å½•
            this.root = process.cwd(); // å½“å‰è¿è¡Œnpxçš„è·¯å¾„
    
            this.hooks = {
                entryOption: new SyncHook(),  // å…¥å£é€‰é¡¹
                compile: new SyncHook(),      // ç¼–è¯‘
                afterCompile: new SyncHook(),  // ç¼–è¯‘å®Œæˆ
                afterPlugins: new SyncHook(),   // ç¼–è¯‘å®Œæ’ä»¶
                run: new SyncHook(),         // è¿è¡Œ
                emit: new SyncHook(),        // å‘å°„
                done: new SyncHook()         // å®Œæˆ
            }
            // å¦‚æœä¼ é€’äº†pluginså‚æ•°
            let plugins = this.config.plugins
            if (Array.isArray(plugins)) {
                plugins.forEach(plugin => {
                    plugin.apply(this); // è¿™é‡Œåªæ˜¯appLyæ–¹æ³•ä¸æ˜¯æ”¹å˜thisæŒ‡å‘
                })
            }
            this.hooks.afterPlugins.call()
        }
    

åœ¨webpack.config.jsä¸­å†™æ’ä»¶æ–¹æ³•

    class P {
        apply(compiler) {   // è¿™é‡Œåªæ˜¯appLyæ–¹æ³•ä¸æ˜¯æ”¹å˜thisæŒ‡å‘
            // ç»‘å®š
            compiler.hooks.emit.tap('emit', function () {
                console.log('emit');
            })
        }
    }
    
    class P1 {
        apply(compiler) {   // è¿™é‡Œåªæ˜¯appLyæ–¹æ³•ä¸æ˜¯æ”¹å˜thisæŒ‡å‘
            // ç»‘å®š
            compiler.hooks.afterPlugins.tap('emit', function () {
                console.log('afterPlugins');
            })
        }
    }
    
    
    
    module.exports = {
        mode: 'development',
        entry: './src/index.js',
        output: {
            filename: 'bundle.js',
            path: path.resolve(__dirname, 'dist')
        },
        module: {
            rules: [
                {
                    test: /\.less$/,
                    use: [
                        path.resolve(__dirname, 'loader', 'style-loader'),
                        path.resolve(__dirname, 'loader', 'less-loader')
                    ]
                }
            ]
        },
        plugins: [
            new P(),
            new P1()
        ]
    }
    

ç„¶ååœ¨å„ä¸ªåœ°æ–¹è°ƒç”¨

may-packä¸­may-pack.js

    .....
    // è°ƒç”¨
    compiler.hooks.entryOption.call()
    // æ ‡è¯†è¿è¡Œç¼–è¯‘
    compiler.run()
    

may-packä¸­Compiler.js

    run() {
            this.hooks.run.call()
    
            this.hooks.compile.call()
            // æ‰§è¡Œ åˆ›å»ºæ¨¡å—çš„ä¾èµ–å…³ç³»
            this.buildModule(path.resolve(this.root, this.entry), true)  // path.resolve(this.root, this.entry) å¾—åˆ°å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
            // console.log(this.modules, this.entryId);
            this.hooks.afterCompile.call()
            // å‘å°„æ‰“åŒ…åçš„æ–‡ä»¶
            this.emitFile()
            this.hooks.emit.call()
            this.hooks.done.call()
        }
    

è¿è¡Œnpx may-pack

loader

æ‰‹å†™loader

webapck.config.js

    let path = require('path')
    
    module.exports = {
        mode: 'development',
        entry: './src/index',
        output: {
            filename: 'build.js',
            path: path.resolve(__dirname, 'dist')
        },
        module: {
            rules: [
                {
                    test: /\.js/,
                    use: 'loader1' // å¦‚ä½•æ‰¾åˆ°è¿™ä¸ªloader1
                }
            ]
        },
    }
    
    

åˆ›å»ºloaderæ–‡ä»¶loader1.js

    console.log(22);
    
    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç 
        return source
    }
    module.exports = loader
    
    

webpack.config.js

    let path = require('path')
    
    module.exports = {
        mode: 'development',
        entry: './src/index.js',
        output: {
            filename: 'build.js',
            path: path.resolve(__dirname, 'dist')
        },
        resolveLoader: {
          // åˆ«å
          // alias: {
          //     loader1: path.resolve(__dirname, 'loader', 'loader1')
          // }
            modules: ['node_modules', path.resolve(__dirname, 'loader')]  // å…ˆæ‰¾node_modules, å†å»loaderä¸­å»æ‰¾
        },
        module: {
            rules: [
                {
                    test: /\.js$/,
                    // use: [path.resolve(__dirname, 'loader', 'loader1')]
                    use: 'loader1' // å¦‚ä½•æ‰¾åˆ°è¿™ä¸ªloader1
    
                },
                // {
                //     test: /\.less$/,
                //     use: [
                //         path.resolve(__dirname, 'loader', 'style-loader'),
                //         path.resolve(__dirname, 'loader', 'less-loader')
                //     ]
                // }
            ]
        },
    }
    
    

å¦‚ä½•æ‰¾åˆ°è¿™ä¸ªloader1

1. é€šè¿‡é…åˆ«åalias
2. é€šè¿‡modules

npx webpack

é…ç½®å¤šä¸ªloader

1. æ•°ç»„æ–¹å¼

å…ˆåˆ†åˆ«åœ¨loaderæ–‡ä»¶ä¸‹åˆ›å»ºï¼Œloader2.jså’Œloader3.js

    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç 
        console.log('loader2');  // loader3.js ç±»ä¼¼
        return source
    }
    module.exports = loader
    
    

webpack.config.js

    rules: [
        {
            test: /\.js$/,
            use: ['loader3', 'loader2', 'loader1']
        },
    ]
    

è¿è¡Œnpx webpack,åˆ†åˆ«æ‰“å‡º

    loader1
    loader2
    loader3
    

1. å¯¹è±¡æ–¹å¼

    rules: [
        {
            test: /\.js$/,
            use: ['loader3']
        },
        {
            test: /\.js$/,
            use: ['loader2']
        },
        {
            test: /\.js$/,
            use: ['loader1']
        }
    ]
    

è¿è¡Œnpx webpack,åˆ†åˆ«æ‰“å‡º

    loader1
    loader2
    loader3
    

loaderçš„é¡ºåº: ä»å³åˆ°å·¦, ä»ä¸‹åˆ°ä¸Š

ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®ä¸åŒçš„å‚æ•°æ”¹å˜loaderçš„æ‰§è¡Œé¡ºåºï¼Œpre å‰é¢çš„ï¼Œ poståœ¨åé¢çš„ï¼Œ normalæ­£å¸¸

    {
        test: /\.js$/,
        use: ['loader1'],
        enforce: "pre"
    },
    {
        test: /\.js$/,
        use: ['loader2']
    },
    {
        test: /\.js$/,
        use: ['loader3'],
        enforce: "post"
    },
    

loader å¸¦å‚æ•°æ‰§è¡Œçš„é¡ºåº: pre  -> normal -> inline -> post

inlineä¸ºè¡Œå†…loader

åœ¨loaderæ–‡ä»¶ä¸­æ–°å»ºinlin-loader

    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç 
        console.log('inline');
        return source
    }
    module.exports = loader
    
    

src/a.js

    module.exports = 'may'
    

src/index

    console.log('hello')
    let srt = require('-!inline-loader!./a')
    

1. -!ç¦ç”¨pre-loaderå’Œ normal-loaderæ¥å¤„ç†äº†

    loader1
    loader2
    loader3
    inline
    loader3
    



1. !ç¦ç”¨normal-loader

    loader1
    loader2
    loader3
    loader1
    inline
    loader3
    



1. !! ç¦ç”¨pre-loaderã€normal-loaderã€post-loader,åªèƒ½è¡Œå†…å¤„ç†

    loader1
    loader2
    loader3
    inline
    

loader é»˜è®¤ç”±ä¸¤éƒ¨åˆ†ç»„æˆpitchå’Œnormal

user: [loader3, loader2, loader1]

æ— è¿”å›å€¼: å…ˆæ‰§è¡Œpitchæ–¹æ³•,ä»å·¦åˆ°å³ï¼Œå†è·å–èµ„æº

        pitch loader - æ— è¿”å›å€¼
        
    pitch   loader3 â†’ loader2 â†’ loader1  
                                        â†˜
                                          èµ„æº
                                        â†™
    normal   loader3 â† loader2 â† loader1 
    

æœ‰è¿”å›å€¼: ç›´æ¥è·³è¿‡åç»­æ‰€æœ‰çš„loaderåŒ…æ‹¬è‡ªå·±çš„,è·³åˆ°ä¹‹å‰çš„loader, å¯ç”¨äºé˜»æ–­

loader

    user: [loader3, loader2, loader1]
    
        pitch loader - æœ‰è¿”å›å€¼
        
    pitch   loader3 â†’ loader2  loader1  
                         â†™               
                   æœ‰è¿”å›å€¼               èµ„æº
                   â†™                      
    normal  loader3  loader2  loader1 
    

loadeer2.js

    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç 
        console.log('loader2');
        return source
    }
    
    loader.pitch = function () {
        return '111'
    }
    module.exports = loader
    
    

ç»“æœ

    loader3
    

babel-loaderå®ç°

yarn add @babel/core @babel/preset-env

webpack.config.js

    {
        test: '\.js$/',
        use: {
            loader: 'babel-loader2',
            options: {
                presets: [
                    '@babel/preset-env'
                ]
            }
        }
    }
    

åœ¨loaderæ–‡ä»¶åˆ›å»ºbabel-loader2.js(å¦‚æœä½ å·²ç»è£…è¿‡babel-loader)

æ‹¿åˆ°babelçš„å‚æ•°

yarn add loader-utils

    // éœ€è¦åœ¨webpack.config.jsæ‹¿åˆ°babelçš„é¢„è®¾, é€šè¿‡é¢„è®¾è½¬æ¢æ¨¡å—, å…ˆå¼•å…¥babel
    let babel = require('@babel/core')
    
    // æ‹¿åˆ°babelçš„å‚æ•° éœ€è¦å·¥å…· loaderUtils
    let loaderUtils =require('loader-utils')
    
    
    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç   è¿™é‡Œçš„thiså°±æ˜¯loaderçš„ä¸Šä¸‹æ–‡
        let options = loaderUtils.getOptions(this)
        console.log(this.resourcePath, 444);   // [./src/index.js]
        let callback = this.async(); // babelçš„è½¬æ¢æ˜¯å¼‚æ­¥çš„,åŒæ­¥çš„è¿”å›æ˜¯ä¸è¡Œçš„ï¼Œ ä¸èƒ½ç”¨return  åŒæ­¥å°±æ˜¯ç›´æ¥æ‰ç”¨ å¼‚æ­¥ä¼šåœ¨asyncä¸­
        babel.transform(source, {
            ...options,
            sourceMap: true,         // æ˜¯å¦è®¾ç½®sourceMap è¿˜éœ€è¦å†webpack.config.js ä¸­é…ç½®  devtool: 'source-map'
            filename: this.resourcePath.split('/').pop()   //  ç»™ç”Ÿæˆçš„`source-map`æŒ‡å®šåå­—
        }, function (err, result) {
            callback(err, result.code, result.map)   // å¼‚æ­¥ å‚æ•°åˆ†åˆ«æ˜¯ã€Œé”™è¯¯ è½¬åŒ–åçš„ä»£ç  å’Œ sourceMapã€
        })
        console.log(options);
        // return source  å¤±æ•ˆ
    }
    
    module.exports = loader
    
    
    

index.js

    class May {
        constructor () {
            this.name = 'may'
        }
        getName () {
            return this.name
        }
    }
    
    
    let may = new May()
    
    console.log(may.getName());
    

npx webpack

banner-loaderå®ç°(è‡ªåˆ›)

ç»™æ‰€æœ‰åŒ¹é…çš„jsåŠ ä¸€ä¸ªæ³¨é‡Š

webpack.config.js

    {    // ç»™æ‰€æœ‰åŒ¹é…çš„`js`åŠ ä¸€ä¸ªæ³¨é‡Š
        test: /\.js$/,
        use: {
            loader: 'banner-loader',
            options: {
               text: 'may',
               filename: path.resolve(__dirname, 'banner.js')
            }
        }
    }
    

banner.js

    äºŒæ¬¡æ˜Ÿçƒä¸­æ¯’
    

åœ¨loaderæ–‡ä»¶åˆ›å»ºbanner-loader.js

yarn add schema-utils æ ¡éªŒè‡ªå·±å†™çš„loaderæ ¼å¼æ˜¯å¦æ­£ç¡®

schema-utils

banner-loader.js

    // æ‹¿åˆ°loaderçš„é…ç½®
    let loaderUtils = require('loader-utils')
    // æ ¡éªŒloader
    let validateOptions = require('schema-utils')
    // è¯»å–æ–‡ä»¶
    let fs = require('fs')  // å¼‚æ­¥
    
    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç 
        let options = loaderUtils.getOptions(this)
        let callback = this.async()  // è¯»å–æ–‡ä»¶æ˜¯å¼‚æ­¥
        let schema = {
            type: 'object',
            properties: {
                text: {
                    type: 'string'
                },
                filename: {
                    type: 'string'
                }
            }
        }
        validateOptions(schema, options, 'banner-loader')  // è‡ªå·±çš„æ ¡éªŒæ ¼å¼ï¼Œ è‡ªå·±çš„å†™çš„é…ç½®ï¼Œ å¯¹åº”çš„loaderåå­—
        if (options.filename) {
            this.cacheable(false)  // ä¸è¦ç¼“å­˜  å¦‚æœæœ‰å¤§é‡è®¡ç®— æ¨èç¼“å­˜
            // this.cacheable && this.cacheable()
            this.addDependency(options.filename) // è‡ªåŠ¨å¢åŠ ä¾èµ–
            fs.readFile(options.filename, 'utf8', function (err, data) {
                callback(err, `/**${data}**/${source}`)
            })
        } else {
            callback(null, `/**${options.text}**/${source}`)
        }
        return source
    }
    module.exports = loader
    
    

ä¼˜åŒ–:

1. ä¿®æ”¹banner.jsçš„å†…å®¹å, webpackè¿›è¡Œç›‘æ§ï¼Œæ‰“åŒ…webapck.config.jsé…ç½®watch: true
2. loaderç¼“å­˜

å®ç°file-loaderå’Œurl-loader

yarn add mime

å…¶ä¸»è¦ç”¨é€”æ˜¯è®¾ç½®æŸç§æ‰©å±•åçš„æ–‡ä»¶çš„å“åº”ç¨‹åºç±»å‹

mime

åˆ›å»ºfile-loader.js1

    // æ‹¿åˆ°babelçš„å‚æ•° éœ€è¦å·¥å…· loaderUtils
    let loaderUtils = require('loader-utils')
    
    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç 
        // file-loaderéœ€è¦è¿”å›è·¯å¾„
        let filename = loaderUtils.interpolateName(this, '[hash].[ext]', {content: source })
        this.emitFile(filename, source) // å‘å°„æ–‡ä»¶
        console.log('loader1');
        return `module.exports="${filename}"`
    }
    loader.raw = true // äºŒè¿›åˆ¶
    module.exports = loader
    
    

åˆ›å»ºurl-loader1.js

    // æ‹¿åˆ°babelçš„å‚æ•° éœ€è¦å·¥å…· loaderUtils
    let loaderUtils = require('loader-utils')
    let mime = require('mime')  // é€”æ˜¯è®¾ç½®æŸç§æ‰©å±•åçš„æ–‡ä»¶çš„å“åº”ç¨‹åºç±»å‹
    
    function loader(source) {  // loaderçš„å‚æ•°å°±æ˜¯æºä»£ç 
        let {limit} = loaderUtils.getOptions(this)
        console.log(this.resourcePath);
        if (limit && limit > source.length) {
            return `module.exports="data:${mime.getType(this.resourcePath)};base64,${source.toString('base64')}"`
        } else {
            return require('./file-loader1').call(this, source)
        }
    }
    loader.raw = true // äºŒè¿›åˆ¶
    module.exports = loader
    
    

webpack.config.js

    {
        test: /\.png$/,
        // ç›®çš„æ˜¯æ ¹æ®å›¾ç‰‡ç”Ÿæˆmd5 å‘å°„åˆ°distç›®å½•ä¸‹ï¼Œfile-loader è¿”å›å½“å‰å›¾ç‰‡è·¯å¾„
        // use: 'file-loader'
        // å¤„ç†è·¯å¾„
        use: {
            loader: 'url-loader1',
            options: {
                limit: 200 * 1024
            }
        }
    }
    

index.jså¼•å…¥å›¾ç‰‡

    import p from './photo.png'
    
    let img = document.createElement('img')
    img.src = p
    document.body.appendChild(img);
    
    

less-loaderå’Œcss-loader

å…ˆå®‰è£…less

åˆ†åˆ«åˆ›å»ºstyle-loader2 css-loader2 less-loader2

style-loader1 ä¸ less-loader1 åŒä¹‹å‰çš„

css-loader

ä¸»è¦ç”¨æ¥å¤„ç†cssä¸­çš„å›¾ç‰‡é“¾æ¥ï¼Œéœ€è¦æŠŠurlè½¬æ¢æˆrequire

webpack.config.js

    {
        test: /\.png$/,
        // ç›®çš„æ˜¯æ ¹æ®å›¾ç‰‡ç”Ÿæˆmd5 å‘å°„åˆ°distç›®å½•ä¸‹ï¼Œfile-loader è¿”å›å½“å‰å›¾ç‰‡è·¯å¾„
        // use: 'file-loader'
        // å¤„ç†è·¯å¾„
        use: {
            loader: 'url-loader1',
            options: {
                limit: 200 * 1024
            }
        }
    },
    {
        test: /\.less$/,
        use: ['style-loader2', 'css-loader2', 'less-loader2']
    }
    

åˆ›å»ºindex.less

    @base: #f938ab;
    body {
      background: @base;
      background: url("./photo.png");
    }
    

less-loader2.js

    // å°†lessè½¬ä¸ºcss
    let less = require('less')
    
    function loader(source) {
        let css = ''
        // console.log(source, 2222);
        less.render(source, function (err, output) {
            // console.log(output);
            css = output.css
        })
        // css = css.replace(/\n/g, '\\n');
        return css
    }
    
    module.exports = loader
    

css-loader2.js

    // css-loader ç”¨æ¥è§£æ@importè¿™ç§è¯­æ³•,åŒ…æ‹¬cssä¸­å¼•å…¥çš„å›¾ç‰‡
    function loader(source) {
        let reg = /url\((.+?)\)/g   // åŒ¹é…æ‹¬å·
    
        let pos = 0;
        let current;
    
        let arr = ['let list = []']
    
        while (current = reg.exec(source)) {
            let [matchUrl, g] = current   // matchUrl -> 'url("./photo.png")', g  -> '"./photo.png"'
            // console.log(matchUrl, g, 88);
            let lastIndex = reg.lastIndex - matchUrl.length    // æ‹¿åˆ°cssä»å¼€é€šåˆ°åœ°å€é“¾æ¥ä¹‹å‰çš„index
            arr.push(`list.push(${JSON.stringify(source.slice(pos, lastIndex))})`)  // æ‹¼å…¥å¼€å§‹å’Œåœ°å€ä¹‹å‰çš„ä»£ç 
            pos = reg.lastIndex
            arr.push(`list.push('url('+ require(${g}) +')')`)    // æ‹¼å…¥å›¾ç‰‡åœ°å€
        }
        arr.push(`list.push(${JSON.stringify(source.slice(pos))})`)  // æ‹¼å…¥åœ°å€åˆ°ç»“å°¾çš„ä»£ç 
        arr.push(`module.exports = list.join('')`)
        console.log(arr.join('\r\n'));
        // let list = []
        // list.push("body {\\n  background: #f938ab;\\n  background: ")
        // list.push('url('+ require("./photo.png") +')')
        // list.push(";\\n}\\n")
        // module.exports = list.join('')
    
        return arr.join('\r\n')
    }
    module.exports = loader
    
    

style-loader2.js

    let loaderUtils = require('loader-utils')
    
    // å°†cssæ’å…¥åˆ°htmlå¤´éƒ¨
    function loader(source) {
        let str = `
        let style = document.createElement('style')
        style.innerHTML = ${JSON.stringify(source)}
        document.head.appendChild(style)
       `
        return str
    }
    
    
    // style-loaderå†™äº†pitch,æœ‰è¿”å›åé¢çš„è·³è¿‡ï¼Œè‡ªå·±çš„å†™ä¸ä¼šèµ°
    loader.pitch = function (remainingRequest) {  // å‰©ä½™çš„è¯·æ±‚
        console.log(loaderUtils.stringifyRequest(this, '!!' + remainingRequest, 99999999))
        // è®©style-loader å¤„ç† less-loader å’Œcss-loaderæ‹¼æ¥çš„ç»“æœ
        // å¾—åˆ° /Users/liuhuimin/work/webpack/loader/css-loader2.js!/Users/liuhuimin/work/webpack/loader/less-loader2.js!/Users/liuhuimin/work/webpack/src/index.less
        // å‰©ä½™çš„è¯·æ±‚ less-loader!css-loader!./index.less
        // console.log(remainingRequest, 1223);
        // requireè¿”å›çš„å°±æ˜¯css-loaderå¤„ç†å¥½çš„ç»“æœrequire('!!css-loader!less-loader!./index.less')
        let str = `
        let style = document.createElement('style')
        style.innerHTML = require(${loaderUtils.stringifyRequest(this, '!!' + remainingRequest)})
        document.head.appendChild(style)
       `
        // stringifyRequest ç»å¯¹è·¯å¾„è½¬ç›¸å¯¹è·¯å¾„
        return str
    }
    module.exports = loader
    
    

    user: ['style-loader2', 'css-loader2', 'less-loader2']
    
        pitch loader - æœ‰è¿”å›å€¼
        
    pitch   style-loader2 â†’ css-loader2  less-loader2  
                         â†™               
                   æœ‰è¿”å›å€¼               èµ„æº
                   â†™                      
    normal  style-loader2  css-loader2  less-loader2
    

åœ¨style-loader2ä¸­ å¼•ç”¨äº†less-loader css-loader å’Œlessæ–‡ä»¶

webpack ä¸­çš„æ’ä»¶

yarn add webpack webpack-cil -D

webpack.config.js

    let path = require('path')
    let DonePlugin = require('./plugins/DonePlugins')
    let AsyncPlugins = require('./plugins/AsyncPlugins')
    
    module.exports = {
        mode: 'development',
        entry: './src/index.js',
        output: {
            filename: 'build.js',
            path: path.resolve(__dirname, 'dist')
        },
        plugins: [
            new DonePlugin(),    // åŒæ­¥
            new AsyncPlugins()   // å¼‚æ­¥
        ]
    }
    
    

node_modules/webpack/libä¸­æŸ¥çœ‹Compiler.js

1. åŒæ­¥plugins/DonePlugins

æ‰“åŒ…å®Œæˆ

    class DonePlugins {
        apply (compiler) {
            console.log(1);
            compiler.hooks.done.tap('DonePlugin', (stats) => {
                console.log('ç¼–è¯‘å®Œæˆ');
            })
        }
    }
    
    
    module.exports = DonePlugins
    
    

1. å¼‚æ­¥plugins/AsyncPlugins

    class AsyncPlugins {
        apply (compiler) {
            console.log(2);
            compiler.hooks.emit.tapAsync('AsyncPlugin', (complete, callback) => {
                setTimeout(() => {
                    console.log('æ–‡ä»¶å‘å°„å‡ºæ¥');
                    callback()
                }, 1000)
            })
            compiler.hooks.emit.tapPromise('AsyncPlugin', (complete, callback) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log('æ–‡ä»¶å‘å°„å‡ºæ¥ 222');
                        resolve()
                    }, 1000)
                })
            })
        }
    }
    
    
    module.exports = AsyncPlugins
    
    

æ–‡ä»¶åˆ—è¡¨æ’ä»¶

å¸Œæœ›ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶æè¿°æ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶

åœ¨pluginsä¸­æ–°å»ºFileListPlugin

    class FileListPlugin {
        constructor ({filename}) {
            this.filename = filename
        }
        apply (compiler) {
            // æ–‡ä»¶å·²ç»å‡†å¤‡å¥½äº† è¦è¿›è¡Œå‘å°„
            // emit
            compiler.hooks.emit.tap('FileListPlugin', (compilation) => {
                let assets = compilation.assets;
                console.log(assets, 55);
                let content = `## æ–‡ä»¶å  èµ„æºå¤§å°\r\n`
                // [ [bundls.js, {}], [index.html, {}]]
                Object.entries(assets).forEach(([filename, stateObj]) => {
                    content += `- ${filename}    ${stateObj.size()}\r\n`
                })
                // èµ„æºå¯¹è±¡
                assets[this.filename] = {
                    source () {
                        return content;
                    },
                    size () {
                        return content.length
                    }
                }
            })
        }
    }
    
    module.exports = FileListPlugin
    
    

    let path = require('path')
    let DonePlugin = require('./plugins/DonePlugins')
    let AsyncPlugins = require('./plugins/AsyncPlugins')
    let HtmlWebpackPlugin = require('html-webpack-plugin')
    let FileListPlugin = require('./plugins/FileListPlugin')
    
    module.exports = {
        mode: 'development',
        entry: './src/index.js',
        output: {
            filename: 'build.js',
            path: path.resolve(__dirname, 'dist')
        },
        plugins: [
            new DonePlugin(),
            new AsyncPlugins(),
            new HtmlWebpackPlugin({
                template: './src/index.html',
                filename: 'index.html'
            }),
            new FileListPlugin({
                filename: 'list.md'
            })
        ]
    }
    
    

ç”Ÿæˆlist.md

å†…è”çš„webpackæ’ä»¶

æ–°å»ºindex.csså¼•å…¥index.js

yarn add css-loader mini-css-extract-plugin -D

å¸Œæœ›æ‰“åŒ…åcssã€jså†…è”åœ¨index.htmlæ–‡ä»¶ä¸­

åˆ›å»ºpluginsä¸­InlineSourcePlugins.js

yarn add --dev html-webpack-plugin@next

HTML Webpack Plugin

webpack.config.js

    let path = require('path')
    let DonePlugin = require('./plugins/DonePlugins')
    let AsyncPlugins = require('./plugins/AsyncPlugins')
    let HtmlWebpackPlugin = require('html-webpack-plugin')
    let FileListPlugin = require('./plugins/FileListPlugin')
    
    let InlineSourcePlugins = require('./plugins/InlineSourcePlugins')
    
    let MiniCssExtractPlugin = require('mini-css-extract-plugin')
    
    module.exports = {
        mode: 'production',
        entry: './src/index.js',
        output: {
            filename: 'bundle.js',
            path: path.resolve(__dirname, 'dist')
        },
        module: {
            rules: [
                {
                    test: /\.css$/,
                    use: [MiniCssExtractPlugin.loader, 'css-loader']
                }
            ]
        },
        plugins: [
            // new DonePlugin(),
            // new AsyncPlugins(),
            new HtmlWebpackPlugin({
                template: './src/index.html',
                filename: 'index.html'
            }),
            new MiniCssExtractPlugin({
                filename: 'index.css'
            }),
            new InlineSourcePlugins({
                match: /\.(js|css)/
            }),
            // new FileListPlugin({
            //     filename: 'list.md'
            // })
        ]
    }
    
    

InlineSourcePlugins.js

    const HtmlWebpackPlugin = require('html-webpack-plugin')
    
    // æŠŠå¤–é“¾çš„æ ‡ç­¾ç¼–ç¨‹å†…è”çš„æ ‡ç­¾
    class InlineSourcePlugins {
        constructor({match}) {
            this.reg = match  // æ­£åˆ™
        }
    
        // å¤„ç†æŸä¸€ä¸ªæ ‡ç­¾
        processTag(tag, compilation) {
            let newTag = {}
            let url = ''
            if (tag.tagName === 'link' && this.reg.test(tag.attributes.href)) {
                newTag = {
                    tagName: 'style',
                    attributes: {type: 'text/css'}
                }
                url = tag.attributes.href
            } else if (tag.tagName === 'script' && this.reg.test(tag.attributes.src)) {
                newTag = {
                    tagName: 'script',
                    attributes: {type: 'application/javascript'}
                }
                url = tag.attributes.src
            }
            if (url) {
                newTag.innerHTML = compilation.assets[url].source(); // æ–‡ä»¶å†…å®¹æ”¾åˆ°innerHTMLå±æ€§ä¸­
                delete compilation.assets[url]   // åˆ é™¤åŸæœ‰çš„èµ„æº
                return newTag
                // console.log(compilation.assets[url].source());
            }
            return tag
        }
    
        // å¤„ç†å¼•å…¥æ ‡ç­¾çš„æ•°æ®
        processTags(data, compilation) {
            let headTags = []
            let bodyTags = []
            data.headTags.forEach(headTag => {
                headTags.push(this.processTag(headTag, compilation))
            })
            data.bodyTags.forEach(bodyTag => {
                bodyTags.push(this.processTag(bodyTag, compilation))
            })
            console.log({...data, headTags, bodyTags})
            return {...data, headTags, bodyTags}
        }
    
    
    
        apply(compiler) {
            // é€šè¿‡webpackPluginæ¥å®ç°  npmæœç´¢  html-webpack-plugin
            compiler.hooks.compilation.tap('InlineSourcePlugins', (compilation) => {
                HtmlWebpackPlugin.getHooks(compilation).alterAssetTagGroups.tapAsync(
                    'alertPlugin',
                    (data, callback) => {
                        // console.log('======');
                        // console.log(data) // æ’å…¥htmlæ ‡ç­¾çš„æ•°æ®
                        // console.log('======');
                        data = this.processTags(data, compilation)   // compilation.assets èµ„æºçš„é“¾æ¥
                        callback(null, data)
                    })
            })
    
        }
    }
    
    module.exports = InlineSourcePlugins
    
    

æ‰“åŒ…åè‡ªåŠ¨å‘å¸ƒ

æ‰“åŒ…å¥½çš„æ–‡ä»¶è‡ªåŠ¨ä¸Šä¼ è‡´ä¸ƒç‰›

éœ€è¦è¿™å‡ ä¸ªå‚æ•°

    bucket: ''  // ä¸ƒç‰›çš„å­˜å‚¨ç©ºé—´
    domain: '',
    accessKey: '', // ä¸ƒç‰›äº‘çš„ä¸¤å¯¹å¯†åŒ™
    secretKey: '' // ä¸ƒç‰›äº‘çš„ä¸¤å¯¹å¯†åŒ™
    

æ³¨å†Œä¸ƒç‰›ï¼Œå¹¶åœ¨å¯¹è±¡å­˜å‚¨é‡Œé¢,æ–°å»ºå­˜å‚¨ç©ºé—´åˆ—è¡¨test,bucket: 'test'

å†…å®¹ç®¡ç†å¤–é“¾æ¥é»˜è®¤åŸŸå domain: 'xxxxxxxx'

å³ä¸Šè§’ä¸ªäººé¢æ¿é‡Œé¢ä¸ªäººä¸­å¿ƒ,å¯†é’¥ç®¡ç†åˆ†åˆ«å¯¹åº”accessKeyå’ŒsecretKey

è¿›å…¥å¼€å‘è€…ä¸­å¿ƒ -> SDK&å·¥å…· -> å®˜æ–¹SDK -> NodeæœåŠ¡ç«¯æ–‡æ¡£ â€”> æ–‡ä»¶ä¸Šä¼ 

nodeæ–‡ä»¶ä¸Šä¼ 



npm install qiniu

compiler-hooks

webpack.config.js

    plugins: [
            new HtmlWebpackPlugin({
                template: './src/index.html',
                filename: 'index.html'
            }),
            new MiniCssExtractPlugin({
                filename: 'index.css'
            }),
            new UploadPlugin({
                bucket: 'test',  // ä¸ƒç‰›çš„å­˜å‚¨ç©ºé—´
                domain: 'poyrjyh1b.bkt.clouddn.com',
                accessKey: 'xxxxxx', // ä¸ƒç‰›äº‘çš„ä¸¤å¯¹å¯†åŒ™
                secretKey: 'yyyyyy' // ä¸ƒç‰›äº‘çš„ä¸¤å¯¹å¯†åŒ™
            })
        ]
    

UploadPlugin.js

    let qiniu = require('qiniu')
    let path = require('path')
    
    class UploadPlugin {
        constructor (options = {}) {
            // å‚è€ƒ https://developer.qiniu.com/kodo/sdk/1289/nodejs
            let { bucket = '', domain = '', accessKey = '', secretKey = ''} = options
            let mac = new qiniu.auth.digest.Mac(accessKey, secretKey)
            let putPolicy = new qiniu.rs.PutPolicy({
                scope: bucket
            });
            this.uploadToken = putPolicy.uploadToken(mac)
            let config = new qiniu.conf.Config();
            this.formUploader = new qiniu.form_up.FormUploader(config)
            this.putExtra = new qiniu.form_up.PutExtra()
        }
        apply (compiler) {
            compiler.hooks.afterEmit.tapPromise('UploadPlugin', (complication) => {
                let assets = complication.assets
                let promise = []
                Object.keys(assets).forEach(filename => {
                    promise.push(this.upload(filename))
                })
                return Promise.all(promise)
            })
        }
    
        upload (filename) {
            return new Promise((resolve, reject) => {
                let localFile = path.resolve(__dirname, '../dist', filename)
                this.formUploader.putFile(this.uploadToken, filename, localFile, this.putExtra, function(respErr,
                                                                                     respBody, respInfo) {
                    if (respErr) {
                        reject(respErr)
                    }
                    if (respInfo.statusCode == 200) {
                        resolve(respBody)
                    } else {
                        console.log(respInfo.statusCode)
                        console.log(respBody)
                    }
                });
            })
        }
    }
    
    module.exports = UploadPlugin
    
